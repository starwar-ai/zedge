# 云电脑业务管理系统技术架构方案

## 1. 系统概述

### 1.1 系统定位
云电脑业务管理系统（Zedge）是一个完整的虚拟桌面基础设施(VDI)管理平台，采用前后端分离架构，基于容器化部署，用于管理云端计算资源、用户访问、实例生命周期和存储资源。

### 1.2 核心功能模块
- **机房管理**：机房、服务器、算力机、云盒管理
- **实例管理**：虚拟机实例生命周期管理、实例组管理
- **用户管理**：用户、用户组、权限、配额管理
- **镜像管理**：镜像库、版本管理、标签管理
- **存储管理**：数据盘管理、快照、备份
- **网络管理**：IP地址池、网络配置管理
- **监控告警**：资源监控、健康检查、告警通知

### 1.3 技术栈
- **前端**：React 18+、TypeScript、Ant Design、React Query
- **后端**：Node.js 18+、Express/Koa、TypeScript
- **数据库**：PostgreSQL 14+
- **缓存**：Redis 7+
- **容器化**：Docker、Docker Compose
- **反向代理**：Nginx

---

## 2. 整体架构设计

### 2.1 架构分层

```
┌─────────────────────────────────────────────────────────────────────┐
│                          前端层 (Frontend Layer)                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  React SPA Application                                        │  │
│  │  - Web管理界面                                                │  │
│  │  - 用户操作界面                                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                │ HTTPS
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          接入层 (Gateway Layer)                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Nginx Reverse Proxy                                          │  │
│  │  - 负载均衡                                                   │  │
│  │  - SSL终止                                                    │  │
│  │  - 静态资源服务                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                │ HTTP
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          API层 (API Layer)                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  RESTful API Gateway                                          │  │
│  │  - 路由转发                                                   │  │
│  │  - 认证鉴权                                                   │  │
│  │  - 请求限流                                                   │  │
│  │  - 日志记录                                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│   业务服务层       │ │   业务服务层       │ │   业务服务层       │
│  (Service Layer)  │ │  (Service Layer)  │ │  (Service Layer)  │
│                   │ │                   │ │                   │
│ - 实例管理服务    │ │ - 用户管理服务    │ │ - 镜像管理服务    │
│ - 资源管理服务    │ │ - 权限管理服务    │ │ - 存储管理服务    │
│ - 网络管理服务    │ │ - 配额管理服务    │ │ - 监控服务        │
└───────────────────┘ └───────────────────┘ └───────────────────┘
        │                       │                       │
        └───────────────┬───────┴───────┬───────────────┘
                        ▼               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          数据层 (Data Layer)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  PostgreSQL  │  │    Redis     │  │  消息队列     │            │
│  │  (主数据库)   │  │  (缓存/会话) │  │  (异步任务)   │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 微服务模块划分

```
┌─────────────────────────────────────────────────────────────────────┐
│                        云电脑业务管理系统                            │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  用户认证服务     │  │  实例管理服务     │  │  资源管理服务     │  │
│  │  (auth-service)  │  │  (instance-svc)  │  │  (resource-svc)  │  │
│  │                  │  │                  │  │                  │  │
│  │ - 用户登录       │  │ - 实例CRUD       │  │ - 机房管理       │  │
│  │ - Token管理      │  │ - 生命周期管理   │  │ - 服务器管理     │  │
│  │ - 权限验证       │  │ - 实例组管理     │  │ - 算力机管理     │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  镜像管理服务     │  │  存储管理服务     │  │  网络管理服务     │  │
│  │  (image-svc)     │  │  (storage-svc)    │  │  (network-svc)   │  │
│  │                  │  │                  │  │                  │  │
│  │ - 镜像CRUD       │  │ - 数据盘管理     │  │ - IP池管理       │  │
│  │ - 版本管理       │  │ - 快照管理       │  │ - 网络配置       │  │
│  │ - 标签管理       │  │ - 备份恢复       │  │ - 路由管理       │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐                         │
│  │  监控服务         │  │  审计服务         │                         │
│  │  (monitor-svc)   │  │  (audit-svc)     │                         │
│  │                  │  │                  │                         │
│  │ - 资源监控       │  │ - 操作日志       │                         │
│  │ - 健康检查       │  │ - 审计追踪       │                         │
│  │ - 告警通知       │  │ - 报表生成       │                         │
│  └──────────────────┘  └──────────────────┘                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 前端架构设计

### 3.1 技术栈
- **框架**：React 18+ (函数式组件 + Hooks)
- **语言**：TypeScript 5+
- **UI组件库**：Ant Design 5+
- **状态管理**：
  - React Query (服务端状态管理)
  - Zustand / Redux Toolkit (客户端状态管理)
- **路由**：React Router 6+
- **HTTP客户端**：Axios
- **构建工具**：Vite
- **代码规范**：ESLint + Prettier

### 3.2 前端目录结构

```
frontend/
├── public/                 # 静态资源
├── src/
│   ├── api/               # API接口定义
│   │   ├── auth.ts
│   │   ├── instance.ts
│   │   ├── user.ts
│   │   └── ...
│   ├── components/         # 通用组件
│   │   ├── Layout/
│   │   ├── Table/
│   │   ├── Form/
│   │   └── ...
│   ├── pages/             # 页面组件
│   │   ├── Login/
│   │   ├── Dashboard/
│   │   ├── Instance/
│   │   ├── User/
│   │   └── ...
│   ├── stores/            # 状态管理
│   │   ├── authStore.ts
│   │   ├── userStore.ts
│   │   └── ...
│   ├── hooks/             # 自定义Hooks
│   ├── utils/             # 工具函数
│   │   ├── request.ts    # Axios封装
│   │   ├── auth.ts       # 认证工具
│   │   └── ...
│   ├── types/             # TypeScript类型定义
│   ├── constants/         # 常量定义
│   ├── styles/            # 全局样式
│   ├── App.tsx
│   └── main.tsx
├── package.json
├── tsconfig.json
├── vite.config.ts
└── Dockerfile
```

### 3.3 前端架构特点

**模块化设计**：
- 按功能模块划分页面和组件
- API接口统一管理，便于维护
- 组件复用性强，减少重复代码

**状态管理策略**：
- 服务端状态：使用React Query管理，自动缓存和同步
- 客户端状态：使用Zustand管理用户偏好、UI状态等
- 表单状态：使用React Hook Form管理复杂表单

**性能优化**：
- 代码分割（Code Splitting）
- 路由懒加载
- 图片懒加载
- 虚拟滚动（大数据列表）
- 防抖节流处理

---

## 4. 后端架构设计

### 4.1 技术栈
- **运行时**：Node.js 18+ LTS
- **框架**：Express.js 或 Koa.js
- **语言**：TypeScript 5+
- **ORM**：Prisma 或 TypeORM
- **认证**：JWT (jsonwebtoken)
- **验证**：Joi 或 Zod
- **日志**：Winston 或 Pino
- **任务队列**：Bull (基于Redis)
- **文件上传**：Multer

### 4.2 后端目录结构

```
backend/
├── src/
│   ├── services/          # 业务服务层
│   │   ├── auth/
│   │   │   ├── auth.service.ts
│   │   │   └── auth.controller.ts
│   │   ├── instance/
│   │   ├── user/
│   │   ├── image/
│   │   └── ...
│   ├── models/            # 数据模型
│   │   ├── User.ts
│   │   ├── Instance.ts
│   │   └── ...
│   ├── routes/            # 路由定义
│   │   ├── auth.routes.ts
│   │   ├── instance.routes.ts
│   │   └── ...
│   ├── middleware/        # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── error.middleware.ts
│   │   ├── validation.middleware.ts
│   │   └── ...
│   ├── utils/             # 工具函数
│   │   ├── logger.ts
│   │   ├── response.ts
│   │   └── ...
│   ├── config/            # 配置文件
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   └── ...
│   ├── types/             # TypeScript类型
│   ├── jobs/              # 定时任务
│   └── app.ts             # 应用入口
├── prisma/                # Prisma配置
│   ├── schema.prisma
│   └── migrations/
├── package.json
├── tsconfig.json
└── Dockerfile
```

### 4.3 后端架构特点

**分层架构**：
- **Controller层**：处理HTTP请求响应
- **Service层**：业务逻辑处理
- **Model层**：数据访问和ORM映射
- **Middleware层**：请求拦截、认证、日志等

**API设计规范**：
- RESTful API设计
- 统一响应格式：`{ code, message, data }`
- 统一错误处理
- API版本控制：`/api/v1/...`

**服务间通信**：
- HTTP调用（同步）
- 消息队列（异步任务）
- 数据库共享（数据一致性）

---

## 5. 数据库架构设计

### 5.1 数据库选型
- **主数据库**：PostgreSQL 14+
- **缓存数据库**：Redis 7+
- **连接池**：PgBouncer（可选）

### 5.2 PostgreSQL数据库设计

**核心表结构**：

```sql
-- 用户相关表
users                          -- 用户表
user_groups                    -- 用户组表
user_group_members             -- 用户组成员关系表
permissions                    -- 权限表
role_permissions               -- 角色权限关联表

-- 机房资源表
computer_rooms                 -- 机房表
servers                        -- 服务器表
compute_machines               -- 算力机表
cloud_boxes                    -- 云盒表

-- 实例相关表
instances                      -- 实例表
instance_groups                -- 实例组表
instance_group_members         -- 实例组成员关系表

-- 镜像相关表
images                         -- 镜像表
image_versions                 -- 镜像版本表
image_tags                     -- 镜像标签表

-- 存储相关表
data_disks                     -- 数据盘表
disk_snapshots                 -- 快照表
disk_attachments               -- 磁盘挂载关系表

-- 网络相关表
networks                       -- 网络表
ip_address_pools              -- IP地址池表
ip_allocations                 -- IP分配记录表

-- 监控审计表
audit_logs                     -- 审计日志表
resource_metrics               -- 资源监控指标表
alerts                         -- 告警表
```

### 5.3 数据库设计原则

**规范化设计**：
- 遵循第三范式（3NF）
- 合理使用外键约束
- 适当冗余以提升查询性能

**索引策略**：
- 主键自动索引
- 外键字段建立索引
- 频繁查询字段建立索引
- 复合索引优化多条件查询

**分表策略**：
- 日志表按时间分表（按月/年）
- 监控指标表按时间分区

**数据备份**：
- 每日全量备份
- 实时WAL归档
- 异地备份存储

### 5.4 Redis使用场景

**缓存策略**：
- 用户会话信息（Session）
- 用户权限信息缓存
- 热点数据缓存（实例列表、资源统计）
- API响应缓存

**分布式锁**：
- 防止并发操作冲突
- 资源分配锁

**消息队列**：
- 异步任务队列（Bull）
- 事件通知

---

## 6. 容器化部署架构

### 6.1 Docker容器划分

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Docker容器架构                               │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  前端容器         │  │  Nginx容器       │  │  API Gateway容器  │  │
│  │  (frontend)      │  │  (nginx)         │  │  (api-gateway)   │  │
│  │                  │  │                  │  │                  │  │
│  │ React静态文件    │  │ 反向代理         │  │ 路由转发         │  │
│  │ Nginx服务        │  │ SSL终止          │  │ 认证鉴权         │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  实例管理服务     │  │  用户管理服务     │  │  镜像管理服务     │  │
│  │  (instance-svc)  │  │  (user-svc)      │  │  (image-svc)     │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  存储管理服务     │  │  监控服务         │  │  任务队列服务     │  │
│  │  (storage-svc)   │  │  (monitor-svc)   │  │  (worker)        │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐                         │
│  │  PostgreSQL容器  │  │  Redis容器       │                         │
│  │  (postgres)      │  │  (redis)         │                         │
│  │                  │  │                  │                         │
│  │ 主数据库         │  │ 缓存/会话/队列   │                         │
│  └──────────────────┘  └──────────────────┘                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 Docker Compose配置结构

```
zedge/
├── docker-compose.yml          # 主配置文件
├── .env                        # 环境变量
├── nginx/
│   ├── nginx.conf              # Nginx配置
│   └── ssl/                    # SSL证书
├── frontend/
│   └── Dockerfile
├── backend/
│   ├── Dockerfile
│   └── src/
├── postgres/
│   ├── init.sql                # 初始化脚本
│   └── backups/                # 备份目录
└── redis/
    └── redis.conf
```

### 6.3 容器网络设计

**网络划分**：
- **frontend-network**：前端和Nginx通信
- **backend-network**：后端服务间通信
- **database-network**：数据库网络（仅后端可访问）

**数据卷挂载**：
- PostgreSQL数据持久化：`postgres_data`
- Redis数据持久化：`redis_data`
- 日志持久化：`logs`
- 上传文件：`uploads`

### 6.4 容器编排特点

**服务依赖**：
- 后端服务依赖PostgreSQL和Redis
- 使用`depends_on`和健康检查确保启动顺序

**资源限制**：
- CPU和内存限制
- 防止资源耗尽

**健康检查**：
- 各服务健康检查端点
- 自动重启失效容器

**日志管理**：
- 统一日志收集
- 日志轮转

---

## 7. 安全架构设计

### 7.1 认证授权

**认证机制**：
- JWT Token认证
- Token刷新机制
- 单点登录（SSO）支持

**授权机制**：
- RBAC（基于角色的访问控制）
- 资源级权限控制
- API权限验证

### 7.2 数据安全

**传输安全**：
- HTTPS加密传输
- SSL/TLS证书配置

**存储安全**：
- 密码加密存储（bcrypt）
- 敏感数据加密
- 数据库访问控制

**API安全**：
- 请求限流（Rate Limiting）
- SQL注入防护（ORM参数化查询）
- XSS防护（输入验证和转义）
- CSRF防护（Token验证）

### 7.3 审计日志

**日志记录**：
- 用户操作日志
- API访问日志
- 系统事件日志
- 错误日志

**日志存储**：
- 结构化日志格式（JSON）
- 日志分级存储
- 日志定期归档

---

## 8. 性能优化策略

### 8.1 前端性能优化

- **代码分割**：按路由懒加载
- **资源压缩**：Gzip/Brotli压缩
- **CDN加速**：静态资源CDN分发
- **缓存策略**：浏览器缓存、HTTP缓存
- **虚拟滚动**：大数据列表优化

### 8.2 后端性能优化

- **数据库优化**：
  - 索引优化
  - 查询优化
  - 连接池配置
  - 读写分离（可选）

- **缓存策略**：
  - Redis缓存热点数据
  - 缓存过期策略
  - 缓存预热

- **异步处理**：
  - 耗时任务异步处理
  - 消息队列解耦
  - 批量操作优化

### 8.3 系统扩展性

**水平扩展**：
- 无状态服务设计
- 多实例负载均衡
- 数据库读写分离

**垂直扩展**：
- 资源监控和调优
- 数据库优化

---

## 9. 监控与运维

### 9.1 监控指标

**系统监控**：
- CPU、内存、磁盘使用率
- 网络流量
- 容器健康状态

**应用监控**：
- API响应时间
- 错误率
- 请求量统计

**数据库监控**：
- 连接数
- 慢查询
- 锁等待

### 9.2 日志管理

**日志收集**：
- 统一日志格式
- 日志聚合（可选：ELK Stack）

**日志分析**：
- 错误日志分析
- 访问日志分析
- 性能分析

### 9.3 告警通知

**告警规则**：
- 服务异常告警
- 资源使用告警
- 错误率告警

**通知方式**：
- 邮件通知
- 短信通知（可选）
- 企业微信/钉钉（可选）

---

## 10. 部署架构

### 10.1 部署环境

**自建环境部署**：
- 物理服务器或虚拟机
- Docker运行时环境
- Docker Compose编排

### 10.2 部署流程

```
1. 环境准备
   ├── 安装Docker和Docker Compose
   ├── 配置网络和防火墙
   └── 准备SSL证书

2. 数据库初始化
   ├── 创建PostgreSQL数据库
   ├── 执行数据库迁移脚本
   └── 初始化基础数据

3. 服务部署
   ├── 构建Docker镜像
   ├── 启动容器服务
   └── 验证服务健康

4. 配置Nginx
   ├── 配置反向代理
   ├── 配置SSL证书
   └── 配置静态资源

5. 系统验证
   ├── 功能测试
   ├── 性能测试
   └── 安全测试
```

### 10.3 高可用部署（可选）

**主备模式**：
- 数据库主备同步
- 应用服务多实例
- Nginx负载均衡

**容器编排升级**：
- Kubernetes（可选）
- 自动扩缩容
- 服务发现

---

## 11. 开发规范

### 11.1 代码规范

**前端**：
- ESLint + Prettier代码格式化
- TypeScript严格模式
- 组件命名规范
- 文件命名规范

**后端**：
- ESLint + Prettier代码格式化
- TypeScript严格模式
- 函数命名规范
- 注释规范

### 11.2 Git工作流

- 主分支：`main`（生产环境）
- 开发分支：`develop`（开发环境）
- 功能分支：`feature/*`（功能开发）
- 修复分支：`fix/*`（Bug修复）

### 11.3 API文档

- Swagger/OpenAPI文档
- API版本控制
- 请求响应示例

---

## 12. 技术选型说明

### 12.1 前端技术选型

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|---------|
| React | 18+ | UI框架 | 成熟稳定，生态丰富 |
| TypeScript | 5+ | 类型系统 | 类型安全，提升开发效率 |
| Ant Design | 5+ | UI组件库 | 企业级组件，开箱即用 |
| React Query | 4+ | 数据获取 | 简化服务端状态管理 |
| Vite | 5+ | 构建工具 | 快速构建，开发体验好 |

### 12.2 后端技术选型

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|---------|
| Node.js | 18+ LTS | 运行时 | 异步I/O，适合高并发 |
| Express/Koa | 4+/3+ | Web框架 | 轻量灵活，中间件丰富 |
| TypeScript | 5+ | 类型系统 | 类型安全，代码可维护 |
| Prisma | 5+ | ORM | 类型安全，迁移方便 |
| JWT | 9+ | 认证 | 无状态认证，适合分布式 |

### 12.3 数据库技术选型

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|---------|
| PostgreSQL | 14+ | 主数据库 | 功能强大，ACID支持完善 |
| Redis | 7+ | 缓存/队列 | 高性能，支持多种数据结构 |

---

## 13. 总结

本架构方案采用前后端分离、微服务化、容器化部署的现代化架构设计，具有以下特点：

**优势**：
- ✅ 前后端分离，独立开发和部署
- ✅ 模块化设计，易于维护和扩展
- ✅ 容器化部署，环境一致性好
- ✅ 技术栈成熟，社区支持好
- ✅ 支持水平扩展，性能可扩展

**适用场景**：
- 中小型团队开发
- 自建环境部署
- 快速迭代开发
- 功能模块较多的大型系统

**后续优化方向**：
- 引入Kubernetes进行容器编排
- 引入消息队列（RabbitMQ/Kafka）解耦服务
- 引入服务网格（Istio）进行服务治理
- 引入分布式追踪（Jaeger/Zipkin）
- 引入ELK Stack进行日志分析

