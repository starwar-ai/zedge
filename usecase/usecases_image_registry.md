# 镜像管理用例 (Image Registry Use Cases)

## 系统概览 (System Overview)

镜像管理系统是云电脑业务管理系统的核心组件，负责存储、管理和分发虚拟机镜像。本文档详细描述了镜像管理系统的所有用例场景，包括镜像生命周期管理、版本控制、权限管理、安全扫描、分发优化等核心功能。

**涉及的主要角色**:
- **系统管理员 (System Admin)**: 拥有完整权限，管理所有镜像和系统配置
- **组织管理员 (Organization Admin)**: 管理组织内的镜像和用户权限
- **开发者 (Developer)**: 创建、上传和管理自己的镜像
- **普通用户 (End User)**: 浏览和使用公共镜像或被授权的私有镜像
- **自动化系统 (Automation System)**: 通过API进行镜像操作的自动化工具

---

## 1. 镜像生命周期管理 (Image Lifecycle Management)

### UC-IMG-001: 上传镜像 (Upload Image)

**参与者**: 开发者、系统管理员、自动化系统

**前置条件**:
- 用户已通过身份认证
- 用户具有镜像上传权限
- 系统有足够的存储空间
- 镜像文件格式符合要求（qcow2、raw、vmdk等）

**基本流程**:
1. 用户选择要上传的镜像文件
2. 填写镜像元数据信息：
   - 镜像名称（唯一标识）
   - 镜像版本/标签
   - 镜像描述
   - 操作系统类型和版本
   - 最小资源要求（CPU、内存、存储）
   - 可见性（public/private/organization）
3. 系统验证镜像名称唯一性
4. 系统检查用户存储配额
5. 开始上传镜像文件：
   - 支持分片上传
   - 支持断点续传
   - 实时显示上传进度
6. 上传完成后系统计算镜像SHA256哈希值
7. 系统进行镜像去重检查：
   - 如果相同哈希的镜像已存在，创建引用而非复制数据
8. 触发自动安全扫描（后台异步）
9. 更新镜像元数据到数据库
10. 返回上传成功响应

**后置条件**:
- 镜像成功存储到对象存储
- 镜像元数据记录在数据库
- 镜像状态为"可用"或"扫描中"
- 用户配额已更新

**异常流程**:
- **E1**: 镜像名称重复 → 提示用户修改名称或版本
- **E2**: 存储配额不足 → 提示用户清理旧镜像或申请扩容
- **E3**: 上传中断 → 保存进度，支持断点续传
- **E4**: 镜像格式不支持 → 返回错误提示
- **E5**: 镜像文件损坏 → 校验失败，提示重新上传

**业务规则**:
- 镜像名称格式：`[namespace/]name:tag`（例如：`ubuntu/desktop:22.04`）
- 单个镜像大小限制：100GB
- 用户默认配额：500GB
- 支持的镜像格式：qcow2、raw、vmdk、vhd、vhdx

**非功能需求**:
- 支持10GB镜像在5分钟内上传完成（1Gbps网络）
- 支持至少100个并发上传任务
- 上传失败自动重试3次

---

### UC-IMG-002: 下载/拉取镜像 (Download/Pull Image)

**参与者**: 所有用户角色、计算节点、自动化系统

**前置条件**:
- 用户已通过身份认证（公开镜像可匿名访问）
- 用户具有镜像访问权限
- 目标存储有足够空间

**基本流程**:
1. 用户指定要下载的镜像（名称:标签）
2. 系统验证用户权限
3. 系统解析镜像标签到具体版本
4. 检查本地缓存是否存在该镜像：
   - 如果存在且哈希匹配 → 直接使用缓存
5. 系统选择最优下载源：
   - 优先选择同边缘机房边缘节点
   - 其次选择就近的缓存节点
   - 最后从中心存储下载
6. 开始下载镜像：
   - 支持分块并行下载
   - 支持断点续传
   - 实时显示下载进度
7. 下载过程中验证数据完整性
8. 下载完成后验证SHA256哈希
9. 将镜像存储到本地指定位置
10. 更新本地镜像索引
11. 记录下载日志

**后置条件**:
- 镜像成功存储到本地
- 镜像可用于创建实例
- 下载统计已更新

**异常流程**:
- **E1**: 权限不足 → 返回403错误
- **E2**: 镜像不存在 → 返回404错误
- **E3**: 下载中断 → 支持断点续传
- **E4**: 哈希校验失败 → 自动重试或提示重新下载
- **E5**: 本地空间不足 → 提示清理空间

**业务规则**:
- 公开镜像允许匿名访问
- 私有镜像需要认证和授权
- 并发下载限制：每用户10个
- 下载速度限制：单用户100MB/s（可配置）

**非功能需求**:
- 同边缘机房下载速度 ≥ 500MB/s
- 跨边缘机房下载速度 ≥ 100MB/s
- 支持至少1000个并发下载
- 下载成功率 ≥ 99.9%

**优化策略**:
- P2P分发：大规模部署时使用BitTorrent协议
- 智能预取：根据使用模式预先缓存热门镜像
- 增量下载：只下载镜像的变化部分（基于层）

---

### UC-IMG-003: 删除镜像 (Delete Image)

**参与者**: 镜像所有者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户是镜像所有者或系统管理员
- 镜像存在且未被锁定

**基本流程**:
1. 用户选择要删除的镜像
2. 系统检查镜像使用情况：
   - 查询是否有实例正在使用该镜像
   - 查询是否有模板引用该镜像
   - 查询是否有子镜像依赖该镜像
3. 显示影响分析给用户
4. 用户确认删除操作
5. 系统标记镜像为"删除中"状态
6. 执行软删除：
   - 从镜像列表中移除
   - 元数据标记为已删除
   - 设置保留期（默认30天）
7. 释放镜像引用的存储资源：
   - 如果无其他镜像共享该层 → 标记为待清理
   - 如果有其他镜像共享 → 仅减少引用计数
8. 更新用户存储配额
9. 记录删除审计日志
10. 返回删除成功响应

**后置条件**:
- 镜像在列表中不可见
- 镜像不可被新实例使用
- 存储空间已标记为可回收
- 用户配额已更新

**异常流程**:
- **E1**: 镜像正在被使用 → 提供两个选项：
  - 强制删除（需要额外确认）
  - 取消删除
- **E2**: 镜像有子镜像依赖 → 提示先删除子镜像或强制删除
- **E3**: 权限不足 → 返回403错误
- **E4**: 镜像已被锁定 → 提示无法删除保护镜像

**业务规则**:
- 软删除保留期：30天（可配置）
- 保留期内可恢复镜像
- 保留期后自动物理删除
- 系统默认镜像不允许删除
- 被标记为"protected"的镜像不允许删除

**扩展流程**:
- **批量删除**: 支持选择多个镜像批量删除
- **定期清理**: 系统定时任务清理过期的已删除镜像
- **级联删除**: 删除镜像时同时删除关联的标签和版本

---

### UC-IMG-004: 更新镜像元数据 (Update Image Metadata)

**参与者**: 镜像所有者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户是镜像所有者或系统管理员
- 镜像存在

**基本流程**:
1. 用户选择要更新的镜像
2. 系统显示当前镜像元数据
3. 用户修改允许的字段：
   - 镜像描述
   - 标签/分类
   - 可见性（public/private/organization）
   - 最小资源要求
   - 推荐规格
   - 自定义属性
4. 系统验证修改的有效性
5. 保存更新的元数据
6. 记录变更历史
7. 更新缓存
8. 返回成功响应

**后置条件**:
- 镜像元数据已更新
- 变更历史已记录
- 缓存已更新

**异常流程**:
- **E1**: 权限不足 → 返回403错误
- **E2**: 字段验证失败 → 提示具体错误
- **E3**: 可见性更改冲突 → 提示处理依赖关系

**业务规则**:
- 不允许修改镜像名称（影响引用）
- 不允许修改镜像内容（需要上传新版本）
- 可见性从public改为private需要警告

---

### UC-IMG-005: 查看镜像详情 (View Image Details)

**参与者**: 所有用户角色

**前置条件**:
- 用户已通过身份认证（公开镜像可匿名访问）
- 用户具有镜像访问权限

**基本流程**:
1. 用户选择或搜索特定镜像
2. 系统验证用户权限
3. 系统查询镜像详细信息：
   - **基本信息**:
     - 镜像名称、ID
     - 创建时间、更新时间
     - 所有者
     - 可见性
   - **技术信息**:
     - 镜像大小
     - 虚拟大小
     - 镜像格式
     - 操作系统类型和版本
     - SHA256哈希值
   - **资源要求**:
     - 最小CPU核心数
     - 最小内存
     - 最小存储空间
     - 推荐规格
   - **版本信息**:
     - 所有版本列表
     - 当前版本标签
   - **使用统计**:
     - 下载次数
     - 当前使用该镜像的实例数
     - 评分和评论（如果启用）
   - **安全信息**:
     - 安全扫描结果
     - 漏洞数量（按严重程度分类）
     - 扫描时间
   - **依赖关系**:
     - 父镜像
     - 子镜像
     - 镜像层信息
4. 显示镜像详情页面
5. 提供相关操作按钮（下载、删除、编辑等）

**后置条件**:
- 用户获得镜像完整信息
- 访问记录已记录

**异常流程**:
- **E1**: 权限不足 → 返回403错误或显示受限信息
- **E2**: 镜像不存在 → 返回404错误

**扩展功能**:
- 显示镜像使用趋势图表
- 显示镜像版本时间线
- 显示关联的模板和实例组
- 提供镜像比较功能

---

## 2. 镜像版本管理 (Image Version Management)

### UC-IMG-006: 创建镜像新版本 (Create New Image Version)

**参与者**: 开发者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户是原镜像所有者或有权限
- 基础镜像存在

**基本流程**:
1. 用户选择基础镜像
2. 用户上传新版本的镜像文件
3. 填写版本信息：
   - 版本号（遵循语义化版本规范）
   - 版本描述/变更日志
   - 标签（可选）
4. 系统验证版本号唯一性
5. 系统分析镜像差异（如果是基于层的格式）：
   - 识别相同的层
   - 只存储变化的层
   - 创建新的manifest
6. 计算新版本哈希值
7. 存储镜像数据和元数据
8. 建立版本关联关系
9. 触发安全扫描
10. 返回成功响应

**后置条件**:
- 新版本已创建并可用
- 版本历史已更新
- 旧版本仍然可用
- 用户可以在不同版本间切换

**异常流程**:
- **E1**: 版本号已存在 → 提示修改版本号
- **E2**: 配额不足 → 提示清理空间
- **E3**: 基础镜像不存在 → 返回错误

**业务规则**:
- 版本号格式：`v<major>.<minor>.<patch>`（例如：v1.2.3）
- 支持自定义标签（例如：latest、stable、beta）
- 每个镜像最多保留100个版本
- 超过限制时自动清理最旧的未使用版本

---

### UC-IMG-007: 版本回滚 (Version Rollback)

**参与者**: 镜像所有者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户有权限操作该镜像
- 镜像有多个版本

**基本流程**:
1. 用户查看镜像版本历史
2. 选择要回滚到的目标版本
3. 系统显示版本差异和影响分析：
   - 当前版本信息
   - 目标版本信息
   - 正在使用当前版本的实例列表
4. 用户确认回滚操作
5. 系统执行回滚：
   - 将"latest"标签指向目标版本
   - 更新默认版本指针
   - 保留原版本（不删除）
6. 通知相关用户和系统
7. 记录回滚审计日志
8. 返回成功响应

**后置条件**:
- 默认版本已切换到目标版本
- 新创建的实例使用回滚后的版本
- 现有实例不受影响（除非手动更新）
- 回滚记录已保存

**异常流程**:
- **E1**: 目标版本不可用 → 提示选择其他版本
- **E2**: 权限不足 → 返回403错误

**扩展流程**:
- **批量更新实例**: 提供选项批量更新使用旧版本的实例

---

### UC-IMG-008: 标签管理 (Tag Management)

**参与者**: 镜像所有者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户有权限操作该镜像

**基本流程**:

**创建标签**:
1. 用户选择镜像版本
2. 用户输入标签名称（例如：latest、stable、v1.0）
3. 系统验证标签格式
4. 系统检查标签是否已存在：
   - 如果存在 → 询问是否覆盖
5. 创建标签指向该版本
6. 更新镜像索引
7. 返回成功响应

**移动标签**:
1. 用户选择已存在的标签
2. 用户选择新的目标版本
3. 系统显示变更影响
4. 用户确认操作
5. 更新标签指向
6. 清理缓存
7. 记录变更日志

**删除标签**:
1. 用户选择要删除的标签
2. 系统检查标签使用情况
3. 用户确认删除
4. 删除标签（镜像版本保留）
5. 更新索引

**后置条件**:
- 标签指向正确的版本
- 标签变更已记录
- 缓存已更新

**业务规则**:
- 保留标签：latest、stable（不允许删除）
- 标签名称限制：字母数字和连字符，最长128字符
- 一个版本可以有多个标签
- 一个标签只能指向一个版本

---

### UC-IMG-009: 版本比较 (Version Comparison)

**参与者**: 所有用户角色

**前置条件**:
- 用户已通过身份认证
- 镜像有多个版本

**基本流程**:
1. 用户选择要比较的两个版本
2. 系统分析版本差异：
   - **元数据差异**:
     - 大小变化
     - 资源要求变化
     - 描述变更
   - **内容差异**:
     - 新增的层
     - 删除的层
     - 修改的文件（如果可分析）
   - **安全差异**:
     - 漏洞变化（新增/修复）
     - 安全评分变化
   - **性能差异**:
     - 启动时间对比
     - 资源消耗对比
3. 生成差异报告
4. 以可视化方式展示差异
5. 提供版本切换建议

**后置条件**:
- 用户了解版本间的具体差异
- 可以做出明智的版本选择决策

**扩展功能**:
- 导出差异报告
- 查看变更日志
- 比较多个版本（3个以上）

---

## 3. 权限与访问控制 (Permission and Access Control)

### UC-IMG-010: 设置镜像可见性 (Set Image Visibility)

**参与者**: 镜像所有者、组织管理员、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户是镜像所有者或管理员

**基本流程**:
1. 用户选择要设置的镜像
2. 系统显示当前可见性设置
3. 用户选择新的可见性级别：
   - **Public（公开）**: 所有用户可访问，包括未认证用户
   - **Private（私有）**: 仅所有者可访问
   - **Organization（组织）**: 组织内所有成员可访问
   - **Shared（共享）**: 特定用户列表可访问
4. 如果选择"组织"或"共享"：
   - 选择目标组织或用户列表
   - 设置访问权限级别（只读/读写）
5. 系统验证权限设置的有效性
6. 应用新的可见性设置
7. 更新访问控制列表（ACL）
8. 清理权限缓存
9. 通知受影响的用户
10. 记录权限变更日志

**后置条件**:
- 镜像可见性已更新
- 访问控制已生效
- 权限变更已记录

**异常流程**:
- **E1**: 权限不足 → 返回403错误
- **E2**: 目标组织不存在 → 提示错误
- **E3**: Public转Private时有外部引用 → 警告并确认

**业务规则**:
- 系统默认镜像始终为Public
- 组织管理员可以设置组织级别的默认可见性
- 改变可见性不影响已创建的实例

---

### UC-IMG-011: 授权用户访问 (Grant User Access)

**参与者**: 镜像所有者、组织管理员、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户有权限管理该镜像
- 镜像为Private或Shared类型

**基本流程**:
1. 用户打开镜像权限管理页面
2. 系统显示当前授权列表
3. 用户添加新的授权：
   - 选择用户或用户组
   - 设置权限类型：
     - **Read（只读）**: 可查看和下载镜像
     - **Write（读写）**: 可修改镜像元数据
     - **Admin（管理）**: 可管理镜像权限
   - 设置过期时间（可选）
4. 系统验证用户存在性
5. 检查是否存在冲突的权限
6. 添加授权记录
7. 更新ACL缓存
8. 向被授权用户发送通知
9. 记录授权日志

**后置条件**:
- 被授权用户可以访问镜像
- 授权记录已保存
- 通知已发送

**异常流程**:
- **E1**: 用户不存在 → 提示错误
- **E2**: 权限冲突 → 提示解决方案
- **E3**: 授权数量超限 → 提示清理或升级

**业务规则**:
- 单个镜像最多授权给1000个用户
- 支持用户组批量授权
- 授权可设置过期时间
- 所有者始终拥有所有权限

---

### UC-IMG-012: 撤销用户访问 (Revoke User Access)

**参与者**: 镜像所有者、组织管理员、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户有权限管理该镜像
- 目标用户当前有访问权限

**基本流程**:
1. 用户打开镜像权限管理页面
2. 系统显示当前授权列表
3. 用户选择要撤销的授权
4. 系统显示撤销影响分析：
   - 该用户使用该镜像创建的实例
   - 该用户引用该镜像的模板
5. 用户确认撤销操作
6. 选择撤销策略：
   - **立即撤销**: 现有实例不受影响，但不能创建新实例
   - **宽限期**: 设置宽限期，期间用户仍可访问
7. 删除授权记录
8. 更新ACL缓存
9. 向被撤销用户发送通知
10. 记录撤销日志

**后置条件**:
- 用户无法继续访问镜像
- 授权记录已删除
- 通知已发送

**异常流程**:
- **E1**: 权限不足 → 返回403错误
- **E2**: 用户不存在 → 提示可能已被删除

**业务规则**:
- 无法撤销所有者的权限
- 撤销后用户无法创建新实例，但现有实例继续运行
- 支持批量撤销

---

### UC-IMG-013: 查看访问日志 (View Access Logs)

**参与者**: 镜像所有者、系统管理员、审计员

**前置条件**:
- 用户已通过身份认证
- 用户有权限查看审计日志

**基本流程**:
1. 用户打开访问日志页面
2. 用户设置过滤条件：
   - 时间范围
   - 操作类型（上传、下载、删除、修改权限等）
   - 用户
   - IP地址
   - 结果（成功/失败）
3. 系统查询日志数据库
4. 展示日志列表，包含：
   - 时间戳
   - 用户
   - 操作类型
   - 操作对象（镜像名称、版本）
   - 源IP地址
   - 结果状态
   - 详细信息
5. 提供日志详情查看
6. 提供日志导出功能

**后置条件**:
- 用户获得访问日志信息
- 可用于审计和问题排查

**扩展功能**:
- 日志可视化分析
- 异常行为告警
- 定期生成审计报告

---

## 4. 镜像安全管理 (Image Security Management)

### UC-IMG-014: 镜像安全扫描 (Image Security Scanning)

**参与者**: 自动化系统、安全管理员、镜像所有者

**前置条件**:
- 镜像已成功上传
- 安全扫描服务正常运行

**基本流程**:

**自动扫描（默认）**:
1. 镜像上传完成后自动触发扫描
2. 系统将镜像加入扫描队列
3. 扫描引擎（Trivy/Clair）执行扫描：
   - 分析镜像层
   - 提取软件包列表
   - 检查已知漏洞数据库（CVE）
   - 检查恶意软件特征
   - 检查敏感信息泄露（密码、密钥等）
   - 检查配置问题
4. 生成扫描报告：
   - 漏洞列表（按严重程度分类）
     - Critical（严重）
     - High（高危）
     - Medium（中危）
     - Low（低危）
   - 受影响的软件包
   - CVE编号和描述
   - 修复建议
   - 安全评分（0-100）
5. 更新镜像安全状态
6. 如果发现严重漏洞 → 发送告警通知
7. 保存扫描报告

**手动扫描**:
1. 用户选择镜像并触发扫描
2. 执行扫描流程（同上）
3. 显示实时扫描进度
4. 扫描完成后显示报告

**后置条件**:
- 镜像有安全评估结果
- 漏洞信息已记录
- 所有者已收到通知（如有严重问题）

**异常流程**:
- **E1**: 扫描失败 → 记录错误，标记为"未扫描"
- **E2**: 扫描超时 → 重新加入队列
- **E3**: 镜像格式不支持 → 标记为"无法扫描"

**业务规则**:
- 所有上传的镜像必须扫描
- 漏洞数据库每日更新
- 已扫描镜像每周自动重新扫描
- Critical漏洞必须通知所有者

**严重性阈值策略**:
- **Critical**: 禁止用于生产环境
- **High**: 警告但允许使用
- **Medium/Low**: 仅记录

---

### UC-IMG-015: 查看安全扫描报告 (View Security Scan Report)

**参与者**: 所有用户角色

**前置条件**:
- 用户已通过身份认证
- 用户有权限查看该镜像
- 镜像已完成安全扫描

**基本流程**:
1. 用户打开镜像详情页面
2. 点击"安全报告"标签
3. 系统展示扫描结果概览：
   - 安全评分
   - 总漏洞数量
   - 按严重程度分类的漏洞统计
   - 扫描时间
   - 扫描器版本
4. 用户查看详细漏洞列表：
   - 每个漏洞显示：
     - CVE编号
     - 严重程度
     - 受影响的软件包和版本
     - 漏洞描述
     - CVSS评分
     - 修复建议
     - 参考链接
5. 提供过滤和排序功能
6. 提供导出报告功能（PDF/JSON/CSV）

**后置条件**:
- 用户了解镜像安全状况
- 可以决定是否使用该镜像

**扩展功能**:
- 比较不同版本的安全性
- 查看漏洞修复历史
- 订阅安全更新通知

---

### UC-IMG-016: 镜像内容信任验证 (Image Content Trust Verification)

**参与者**: 所有用户角色、自动化系统

**前置条件**:
- 镜像已签名
- 启用内容信任功能

**基本流程**:

**镜像签名（上传时）**:
1. 开发者上传镜像
2. 使用私钥对镜像进行数字签名
3. 签名元数据随镜像一起存储
4. 签名包含：
   - 镜像哈希
   - 签名者身份
   - 签名时间戳
   - 公钥指纹

**镜像验证（下载时）**:
1. 用户下载镜像
2. 系统获取镜像签名
3. 使用签名者公钥验证签名
4. 验证镜像哈希是否匹配
5. 检查签名是否在有效期内
6. 检查签名者是否在信任列表中
7. 验证通过 → 允许使用
8. 验证失败 → 警告或阻止使用

**后置条件**:
- 确保镜像未被篡改
- 确保镜像来自可信来源

**异常流程**:
- **E1**: 签名验证失败 → 阻止使用，发出告警
- **E2**: 未签名镜像 → 根据策略决定是否允许
- **E3**: 签名者不在信任列表 → 警告用户

**业务规则**:
- 生产环境强制要求签名镜像
- 开发环境可以使用未签名镜像
- 系统管理员可以管理信任列表

---

### UC-IMG-017: 设置安全策略 (Set Security Policy)

**参与者**: 系统管理员、安全管理员

**前置条件**:
- 用户已通过身份认证
- 用户是系统管理员或安全管理员

**基本流程**:
1. 管理员打开安全策略配置页面
2. 配置镜像安全策略：

   **扫描策略**:
   - 自动扫描：启用/禁用
   - 扫描频率：每日/每周/每月
   - 扫描范围：所有镜像/仅私有/仅公开

   **漏洞阈值策略**:
   - Critical漏洞：阻止/警告/允许
   - High漏洞：阻止/警告/允许
   - Medium漏洞：警告/允许/忽略
   - Low漏洞：允许/忽略

   **内容信任策略**:
   - 要求签名：始终/生产环境/不要求
   - 信任的签名者列表
   - 签名有效期

   **合规性检查**:
   - 禁止的软件包列表
   - 禁止的许可证类型
   - 必需的安全基线配置

   **告警策略**:
   - 告警接收人
   - 告警方式（邮件/短信/Webhook）
   - 告警阈值

3. 系统验证策略配置
4. 保存策略配置
5. 应用策略到所有新镜像
6. 可选：对现有镜像重新评估

**后置条件**:
- 安全策略已生效
- 不符合策略的镜像被标记或阻止

**业务规则**:
- 策略变更需要审批
- 策略应用不影响已运行的实例
- 提供策略模板（严格/标准/宽松）

---

## 5. 镜像存储与分发 (Image Storage and Distribution)

### UC-IMG-018: 镜像层去重 (Image Layer Deduplication)

**参与者**: 自动化系统

**前置条件**:
- 镜像采用分层格式（如Docker镜像）
- 存储系统支持去重

**基本流程**:
1. 用户上传新镜像
2. 系统解析镜像manifest
3. 提取镜像层列表和哈希值
4. 对每一层执行去重检查：
   - 计算层的SHA256哈希
   - 查询哈希索引数据库
   - 如果哈希已存在：
     - 不存储重复数据
     - 创建引用指向已有层
     - 增加引用计数
   - 如果哈希不存在：
     - 存储该层数据
     - 创建新的哈希索引
     - 设置引用计数为1
5. 创建镜像manifest（记录层引用）
6. 计算节省的存储空间
7. 更新存储统计

**后置条件**:
- 重复的层只存储一份
- 显著节省存储空间
- 不影响镜像功能

**业务规则**:
- 去重基于内容哈希（SHA256）
- 即使层来自不同镜像也会去重
- 删除镜像时根据引用计数决定是否删除层

**性能优化**:
- 使用Redis缓存热点哈希查询
- 并行处理多个层的去重
- 定期清理零引用的层

**预期效果**:
- 相同基础镜像的衍生镜像节省80%以上空间
- 加速镜像上传（跳过已存在的层）
- 降低存储成本

---

### UC-IMG-019: 智能缓存管理 (Intelligent Cache Management)

**参与者**: 自动化系统

**前置条件**:
- 边缘节点已部署
- 缓存系统正常运行

**基本流程**:

**缓存预热**:
1. 系统分析镜像使用模式：
   - 热门镜像（下载频率高）
   - 区域热门镜像（特定边缘机房使用频繁）
   - 即将使用的镜像（根据部署计划）
2. 计算缓存优先级
3. 将高优先级镜像推送到边缘节点
4. 验证缓存完整性

**缓存命中处理**:
1. 用户请求下载镜像
2. 系统识别用户所在区域
3. 检查最近的边缘节点缓存
4. 如果缓存命中：
   - 从边缘节点下载
   - 记录命中日志
   - 更新缓存热度
5. 如果缓存未命中：
   - 从中心存储下载
   - 异步写入边缘缓存
   - 记录未命中日志

**缓存淘汰**:
1. 监控缓存使用率
2. 当缓存空间不足时：
   - 使用LRU（最近最少使用）算法
   - 考虑镜像大小和热度
   - 保护高优先级镜像
3. 清理过期缓存
4. 记录淘汰日志

**后置条件**:
- 缓存命中率提升
- 下载速度加快
- 中心存储压力减小

**业务规则**:
- 系统默认镜像永久缓存
- 缓存节点容量：中心存储的20%
- 缓存有效期：30天（可配置）
- 最小缓存命中率目标：80%

**监控指标**:
- 缓存命中率
- 平均下载速度
- 缓存空间使用率
- 各区域热门镜像

---

### UC-IMG-020: P2P分发加速 (P2P Distribution Acceleration)

**参与者**: 自动化系统、计算节点

**前置条件**:
- P2P分发功能已启用
- 计算节点支持P2P协议

**基本流程**:

**大规模部署场景**:
1. 管理员启动批量部署（例如1000个实例）
2. 所有实例需要相同的镜像
3. 系统检测到大规模下载需求
4. 启用P2P分发模式：

   **Tracker协调**:
   - 中心Tracker记录所有参与节点
   - 跟踪镜像块的分布情况
   - 协调节点间的数据传输

   **节点行为**:
   - 第一批节点从中心下载完整镜像
   - 下载完成后成为种子节点（Seeder）
   - 后续节点从多个种子节点并行下载
   - 使用BitTorrent协议分块传输
   - 每个节点下载的同时也在上传

   **带宽优化**:
   - 优先从同边缘机房节点下载
   - 动态调整上传/下载带宽限制
   - 避免影响业务流量

5. 监控P2P分发进度
6. 所有节点完成下载
7. 统计分发效率和带宽节省

**后置条件**:
- 大规模部署速度提升5-10倍
- 中心存储带宽消耗减少80%以上
- 所有节点成功获取镜像

**异常流程**:
- **E1**: 节点网络隔离 → 降级为传统下载
- **E2**: P2P传输失败 → 回退到中心下载
- **E3**: 数据损坏 → 重新下载损坏的块

**业务规则**:
- 仅在批量部署（>100个节点）时启用P2P
- 单节点上传带宽限制：10MB/s
- P2P超时时间：30分钟
- 超时后自动回退到传统模式

**适用场景**:
- 批量部署云桌面
- 跨边缘机房镜像同步
- 大文件镜像分发（>10GB）

---

### UC-IMG-021: 跨边缘机房镜像同步 (Cross-Region Image Synchronization)

**参与者**: 自动化系统、系统管理员

**前置条件**:
- 多个边缘机房已配置
- 边缘机房间网络互通
- 同步策略已配置

**基本流程**:

**自动同步**:
1. 用户在边缘机房A上传新镜像
2. 镜像标记为需要同步（根据策略）
3. 系统检查同步策略：
   - 全局镜像：同步到所有边缘机房
   - 区域镜像：同步到指定区域
   - 按需镜像：首次使用时同步
4. 创建同步任务：
   - 目标边缘机房列表
   - 优先级
   - 同步方式（全量/增量）
5. 执行同步：
   - 压缩镜像数据
   - 传输到目标边缘机房
   - 验证数据完整性
   - 更新本地镜像索引
6. 更新同步状态
7. 发送完成通知

**手动同步**:
1. 管理员选择镜像
2. 选择目标边缘机房
3. 触发同步任务
4. 监控同步进度
5. 同步完成后验证

**增量同步**:
1. 检测镜像是否有相同的基础层
2. 只传输变化的层
3. 在目标边缘机房重建镜像

**后置条件**:
- 镜像在多个边缘机房可用
- 用户可以就近访问镜像
- 跨边缘机房部署加速

**异常流程**:
- **E1**: 网络中断 → 断点续传
- **E2**: 目标边缘机房空间不足 → 暂停同步，发送告警
- **E3**: 数据校验失败 → 重试或告警

**业务规则**:
- 系统默认镜像自动同步到所有边缘机房
- 私有镜像默认不自动同步
- 同步任务在低峰期执行
- 同步失败自动重试3次

**同步策略**:
- **实时同步**: 镜像上传后立即同步（高优先级镜像）
- **定时同步**: 每日凌晨批量同步（常规镜像）
- **按需同步**: 首次使用时触发同步（低优先级镜像）

---

### UC-IMG-022: 镜像存储配额管理 (Image Storage Quota Management)

**参与者**: 系统管理员、组织管理员、用户

**前置条件**:
- 配额系统已启用
- 用户/组织已分配配额

**基本流程**:

**配额分配**:
1. 系统管理员登录管理控制台
2. 选择用户或组织
3. 设置存储配额：
   - 总配额（GB）
   - 镜像数量限制
   - 单个镜像大小限制
   - 上传带宽限制
   - 下载带宽限制
4. 设置配额告警阈值：
   - 80%使用率 → 警告
   - 90%使用率 → 严重警告
   - 100%使用率 → 禁止上传
5. 保存配额配置
6. 通知用户

**配额监控**:
1. 系统实时监控用户配额使用情况
2. 计算当前使用量：
   - 所有镜像总大小
   - 去重后的实际占用空间
   - 镜像数量
3. 当达到阈值时：
   - 发送告警通知
   - 在用户界面显示警告
4. 定期生成配额使用报告

**配额超限处理**:
1. 用户尝试上传新镜像
2. 系统检查配额
3. 如果超限：
   - 阻止上传
   - 显示错误消息：当前使用量、配额限制
   - 提供清理建议：
     - 列出未使用的镜像
     - 列出旧版本镜像
     - 提供删除操作
   - 提供配额申请入口
4. 用户清理空间或申请扩容
5. 配额恢复正常后继续使用

**配额申请**:
1. 用户提交配额扩容申请
2. 填写申请理由和目标配额
3. 提交审批流程
4. 管理员审批
5. 审批通过后自动更新配额
6. 通知用户

**后置条件**:
- 用户配额得到有效控制
- 防止存储资源滥用
- 合理分配存储资源

**业务规则**:
- 默认用户配额：500GB
- 默认组织配额：5TB
- 免费用户：50GB
- 企业用户：可自定义配额
- 配额统计基于实际占用空间（去重后）

**扩展功能**:
- 配额使用趋势分析
- 自动清理策略（删除N天未使用的镜像）
- 配额超售（总分配配额 > 实际存储容量）

---

## 6. 镜像模板管理 (Image Template Management)

### UC-IMG-023: 从镜像创建模板 (Create Template from Image)

**参与者**: 开发者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 基础镜像存在且可访问

**基本流程**:
1. 用户选择基础镜像
2. 填写模板信息：
   - 模板名称
   - 模板描述
   - 模板类型：
     - **实例模板**: 单个云桌面配置
     - **实例组模板**: 多个实例的批量配置
   - 资源配置：
     - CPU核心数
     - 内存大小
     - 系统盘大小
     - 数据盘配置（可选）
   - 网络配置：
     - 网络类型
     - 安全组
     - 公网IP（是/否）
   - 自定义配置：
     - 启动脚本（cloud-init）
     - 环境变量
     - 预装软件列表
   - 可见性：public/private/organization
3. 系统验证配置的合法性：
   - 资源配置满足镜像最小要求
   - 网络配置有效
   - 脚本语法正确
4. 保存模板配置
5. 生成模板ID
6. 返回成功响应

**后置条件**:
- 模板已创建并可用
- 可用于快速部署实例
- 模板已加入模板库

**异常流程**:
- **E1**: 模板名称重复 → 提示修改名称
- **E2**: 资源配置不满足镜像要求 → 显示最小要求
- **E3**: 启动脚本错误 → 验证失败，提示修改

**业务规则**:
- 模板名称唯一性范围：组织内
- 模板继承镜像的安全策略
- 模板可以覆盖镜像的资源建议值
- 模板支持参数化（变量替换）

---

### UC-IMG-024: 使用模板部署实例 (Deploy Instance from Template)

**参与者**: 所有用户角色

**前置条件**:
- 用户已通过身份认证
- 用户有权限使用该模板
- 有足够的计算资源

**基本流程**:

**单实例部署**:
1. 用户浏览模板库
2. 选择合适的模板
3. 查看模板详情和预估成本
4. 自定义部署参数（可选）：
   - 实例名称
   - 部署边缘机房
   - 资源调整（在模板基础上）
   - 网络配置调整
5. 确认部署
6. 系统创建实例：
   - 分配计算资源
   - 下载镜像到计算节点
   - 创建虚拟机
   - 应用模板配置
   - 执行启动脚本
7. 实例启动
8. 返回实例信息

**批量部署（实例组）**:
1. 用户选择实例组模板
2. 设置部署参数：
   - 实例数量
   - 命名规则（prefix-001, prefix-002...）
   - 分布策略（集中/分散）
   - 部署速度（串行/并行）
3. 确认批量部署
4. 系统并行创建多个实例
5. 实时显示部署进度
6. 所有实例启动完成
7. 生成部署报告

**后置条件**:
- 实例成功创建并运行
- 实例配置符合模板定义
- 用户可以访问实例

**异常流程**:
- **E1**: 资源不足 → 提示选择其他边缘机房或等待
- **E2**: 镜像下载失败 → 重试或使用缓存
- **E3**: 启动脚本执行失败 → 记录日志，实例仍创建但标记警告
- **E4**: 部分实例创建失败（批量部署）→ 继续创建其他实例，最后报告失败清单

**业务规则**:
- 单次批量部署上限：1000个实例
- 模板可以设置部署限制（如仅特定边缘机房）
- 使用模板不影响原始镜像

---

### UC-IMG-025: 模板版本管理 (Template Version Management)

**参与者**: 模板所有者、系统管理员

**前置条件**:
- 用户已通过身份认证
- 用户有权限管理该模板

**基本流程**:

**创建新版本**:
1. 用户选择现有模板
2. 选择"创建新版本"
3. 修改模板配置：
   - 更新资源配置
   - 更新启动脚本
   - 更改基础镜像（可选）
   - 添加新的自定义配置
4. 填写版本说明和变更日志
5. 设置版本号（自动递增或手动指定）
6. 保存新版本
7. 选择是否设为默认版本

**版本比较**:
1. 用户选择模板
2. 查看版本历史
3. 选择两个版本进行比较
4. 系统显示差异：
   - 配置项差异
   - 资源变化
   - 脚本差异（diff格式）
5. 提供版本切换建议

**版本回滚**:
1. 用户选择历史版本
2. 确认回滚操作
3. 将该版本设为默认版本
4. 通知使用该模板的用户

**后置条件**:
- 模板有多个版本可选
- 用户可以使用不同版本部署
- 版本历史完整记录

**业务规则**:
- 每个模板最多保留50个版本
- 默认版本可以随时切换
- 旧版本仍然可用（除非删除）
- 版本号遵循语义化版本规范

---

## 7. 镜像集成与自动化 (Image Integration and Automation)

### UC-IMG-026: CI/CD集成 - 自动构建镜像 (CI/CD Integration - Auto Build Image)

**参与者**: 自动化系统、开发者

**前置条件**:
- CI/CD流水线已配置
- 镜像构建脚本已准备
- 有构建权限的API Token

**基本流程**:

**代码提交触发**:
1. 开发者提交代码到Git仓库
2. Git Webhook触发CI/CD流水线
3. CI系统执行构建任务：

   **镜像构建**:
   - 拉取代码
   - 读取Dockerfile或镜像构建脚本
   - 执行构建命令：
     ```bash
     docker build -t myapp:${VERSION} .
     ```
   - 运行单元测试
   - 运行集成测试

   **镜像处理**:
   - 标记镜像版本（基于Git tag或commit hash）
   - 压缩和优化镜像
   - 生成镜像元数据

   **上传到镜像库**:
   - 使用API Token认证
   - 上传镜像到镜像库：
     ```bash
     docker push registry.zedge.com/myapp:${VERSION}
     ```
   - 添加标签（latest、stable等）
   - 更新元数据

4. 自动触发安全扫描
5. 扫描通过后自动部署到测试环境
6. 发送构建结果通知（成功/失败）

**后置条件**:
- 新版本镜像自动发布
- 开发到部署全自动化
- 镜像质量有保障（经过测试和扫描）

**异常流程**:
- **E1**: 构建失败 → 停止流程，发送失败通知
- **E2**: 测试失败 → 不上传镜像，标记为unstable
- **E3**: 安全扫描发现严重漏洞 → 阻止部署，发送告警

**业务规则**:
- 所有生产镜像必须通过CI/CD构建
- 手动上传的镜像标记为"未验证"
- 自动构建的镜像包含完整的构建信息（commit hash、构建时间、构建者）

**典型流水线配置（GitLab CI示例）**:
```yaml
stages:
  - build
  - test
  - push
  - deploy

build:
  stage: build
  script:
    - docker build -t myapp:$CI_COMMIT_SHA .

test:
  stage: test
  script:
    - docker run myapp:$CI_COMMIT_SHA npm test

push:
  stage: push
  script:
    - docker tag myapp:$CI_COMMIT_SHA registry.zedge.com/myapp:$CI_COMMIT_TAG
    - docker push registry.zedge.com/myapp:$CI_COMMIT_TAG
  only:
    - tags

deploy:
  stage: deploy
  script:
    - curl -X POST https://api.zedge.com/deployments \
        -H "Authorization: Bearer $API_TOKEN" \
        -d '{"image":"myapp:'$CI_COMMIT_TAG'","env":"staging"}'
  only:
    - tags
```

---

### UC-IMG-027: 镜像自动更新通知 (Image Auto-Update Notification)

**参与者**: 自动化系统、镜像订阅者

**前置条件**:
- 用户已订阅镜像更新
- 通知系统正常运行

**基本流程**:

**订阅镜像**:
1. 用户打开镜像详情页
2. 点击"订阅更新"
3. 选择通知方式：
   - 邮件
   - 站内消息
   - Webhook
   - Slack/钉钉等
4. 选择通知条件：
   - 新版本发布
   - 安全漏洞发现
   - 标签变更（如latest更新）
5. 确认订阅

**发送通知**:
1. 镜像有更新（新版本上传、安全扫描结果等）
2. 系统查询订阅者列表
3. 生成通知内容：
   - 镜像名称和新版本
   - 变更摘要
   - 重要变更（如breaking changes）
   - 安全相关信息
   - 升级建议
4. 通过配置的渠道发送通知
5. 记录通知日志

**自动更新策略**:
1. 管理员配置自动更新策略：
   - 自动更新范围：
     - 仅patch版本（v1.0.x）
     - 包括minor版本（v1.x.x）
     - 包括major版本（v*.x.x）
   - 更新时间窗口：
     - 立即更新
     - 维护窗口更新
     - 手动确认后更新
   - 回滚策略：
     - 自动回滚条件
     - 回滚审批流程
2. 系统按策略自动更新实例使用的镜像

**后置条件**:
- 订阅者及时了解镜像更新
- 可以决定是否升级实例
- 自动化运维效率提升

**通知示例（邮件）**:
```
主题：[镜像更新] ubuntu/desktop 新版本 v22.04.3 已发布

尊敬的用户：

您订阅的镜像 "ubuntu/desktop" 有新版本发布。

版本信息：
- 当前版本：v22.04.2
- 最新版本：v22.04.3
- 发布时间：2024-10-31 10:00:00

主要变更：
- 安全更新：修复3个High级别漏洞（CVE-2024-xxxx）
- 功能改进：更新显卡驱动至535.xxx
- 性能优化：启动速度提升15%

安全扫描：
- 漏洞：0 Critical, 1 High, 5 Medium
- 安全评分：92/100

升级建议：
建议尽快升级以获得安全修复和性能改进。

操作方式：
1. 自动升级：使用命令 `zedge instance update --image ubuntu/desktop:v22.04.3`
2. 手动升级：在控制台选择实例 → 更新镜像
3. 查看详情：https://registry.zedge.com/images/ubuntu/desktop:v22.04.3

如有问题，请联系技术支持。

---
云电脑业务管理系统
```

---

### UC-IMG-028: API接口管理 (API Management)

**参与者**: 开发者、自动化系统、第三方应用

**前置条件**:
- 用户已通过身份认证
- 已获得API访问令牌

**提供的API接口**:

**镜像管理API**:
```
# 列出镜像
GET /api/v1/images?page=1&size=20&filter=public

# 获取镜像详情
GET /api/v1/images/{image_id}

# 上传镜像
POST /api/v1/images
Content-Type: multipart/form-data
Body: {
  "file": <binary>,
  "name": "myapp",
  "version": "v1.0.0",
  "description": "My application",
  "visibility": "private"
}

# 更新镜像元数据
PATCH /api/v1/images/{image_id}
Body: {
  "description": "Updated description",
  "tags": ["production", "stable"]
}

# 删除镜像
DELETE /api/v1/images/{image_id}

# 下载镜像
GET /api/v1/images/{image_id}/download

# 搜索镜像
GET /api/v1/images/search?q=ubuntu&type=os
```

**版本管理API**:
```
# 列出镜像所有版本
GET /api/v1/images/{image_name}/versions

# 获取特定版本
GET /api/v1/images/{image_name}/versions/{version}

# 创建新版本
POST /api/v1/images/{image_name}/versions

# 标签管理
POST /api/v1/images/{image_name}/tags
Body: {
  "tag": "latest",
  "version": "v1.2.0"
}

DELETE /api/v1/images/{image_name}/tags/{tag}
```

**权限管理API**:
```
# 获取镜像权限
GET /api/v1/images/{image_id}/permissions

# 授权用户
POST /api/v1/images/{image_id}/permissions
Body: {
  "user_id": "user123",
  "permission": "read"
}

# 撤销权限
DELETE /api/v1/images/{image_id}/permissions/{user_id}
```

**安全扫描API**:
```
# 触发安全扫描
POST /api/v1/images/{image_id}/scan

# 获取扫描结果
GET /api/v1/images/{image_id}/scan/results

# 获取漏洞详情
GET /api/v1/images/{image_id}/vulnerabilities
```

**使用示例（Python）**:
```python
import requests

# 认证
headers = {
    "Authorization": f"Bearer {api_token}",
    "Content-Type": "application/json"
}

# 上传镜像
with open("myapp.qcow2", "rb") as f:
    files = {"file": f}
    data = {
        "name": "myapp",
        "version": "v1.0.0",
        "visibility": "private"
    }
    response = requests.post(
        "https://api.zedge.com/v1/images",
        headers=headers,
        files=files,
        data=data
    )
    image_id = response.json()["id"]

# 触发安全扫描
requests.post(
    f"https://api.zedge.com/v1/images/{image_id}/scan",
    headers=headers
)

# 获取扫描结果
scan_result = requests.get(
    f"https://api.zedge.com/v1/images/{image_id}/scan/results",
    headers=headers
).json()

print(f"Security score: {scan_result['score']}")
print(f"Vulnerabilities: {scan_result['vulnerabilities']}")
```

**后置条件**:
- 第三方应用可以集成镜像管理功能
- 自动化脚本可以操作镜像
- 完整的API文档和SDK

**业务规则**:
- API限流：每用户1000次/小时
- API版本：向后兼容至少2个大版本
- 认证方式：Bearer Token（JWT）
- 支持Webhook回调

---

## 8. 镜像监控与运维 (Image Monitoring and Operations)

### UC-IMG-029: 镜像使用统计 (Image Usage Statistics)

**参与者**: 系统管理员、组织管理员、镜像所有者

**前置条件**:
- 用户已通过身份认证
- 统计系统正常运行

**基本流程**:
1. 用户打开镜像统计页面
2. 选择统计范围：
   - 时间范围（今天/本周/本月/自定义）
   - 镜像范围（全部/我的/组织的）
   - 边缘机房范围（全部/特定边缘机房）
3. 系统查询统计数据
4. 展示统计信息：

   **总体统计**:
   - 镜像总数
   - 总存储占用（实际/虚拟）
   - 总下载次数
   - 活跃用户数

   **热门镜像Top 10**:
   - 镜像名称
   - 下载次数
   - 使用实例数
   - 平均评分

   **使用趋势**:
   - 下载趋势图（时间序列）
   - 存储增长趋势
   - 用户增长趋势

   **镜像详细统计**:
   - 每个镜像的详细数据：
     - 总下载次数
     - 当前使用的实例数
     - 平均下载时间
     - 不同版本的使用分布
     - 地域分布
     - 用户分布

   **性能指标**:
   - 平均上传速度
   - 平均下载速度
   - 缓存命中率
   - API响应时间

5. 提供数据导出功能（CSV/Excel/JSON）
6. 提供报表生成功能

**后置条件**:
- 管理员了解镜像使用情况
- 可以优化资源分配
- 可以识别问题和趋势

**扩展功能**:
- 自定义统计报表
- 定期自动发送统计报告
- 异常检测和告警（如突然的大量下载）

---

### UC-IMG-030: 镜像健康检查 (Image Health Check)

**参与者**: 自动化系统、系统管理员

**前置条件**:
- 健康检查系统已启用
- 检查策略已配置

**基本流程**:

**自动健康检查**:
1. 系统定期（每小时）执行健康检查
2. 对每个镜像执行检查项：

   **完整性检查**:
   - 验证镜像文件是否完整
   - 验证SHA256哈希是否匹配
   - 验证镜像层是否完整

   **可用性检查**:
   - 尝试读取镜像文件
   - 检查存储后端是否可访问
   - 验证镜像元数据是否正确

   **安全性检查**:
   - 检查安全扫描是否过期（>7天）
   - 检查是否有新的漏洞信息
   - 验证签名是否有效

   **性能检查**:
   - 测试下载速度
   - 检查缓存状态
   - 验证网络连通性

3. 记录检查结果
4. 如果发现问题：
   - 标记镜像状态（警告/错误）
   - 发送告警通知
   - 尝试自动修复（如重新生成缓存）
5. 生成健康报告

**手动健康检查**:
1. 管理员选择镜像
2. 触发立即健康检查
3. 显示实时检查进度
4. 显示详细检查结果
5. 提供修复建议

**自动修复**:
1. 检测到问题（如哈希不匹配）
2. 执行修复操作：
   - 重新计算哈希
   - 重新生成缓存
   - 重新同步镜像
   - 清理损坏的数据
3. 验证修复结果
4. 记录修复日志

**后置条件**:
- 镜像健康状态清晰
- 问题及时发现和修复
- 系统可靠性提升

**健康状态定义**:
- **Healthy（健康）**: 所有检查通过
- **Warning（警告）**: 有轻微问题但不影响使用
- **Degraded（降级）**: 性能下降但仍可用
- **Unhealthy（不健康）**: 有严重问题，建议不使用
- **Unavailable（不可用）**: 无法访问或损坏

**告警规则**:
- 单个镜像不可用 → 发送通知给所有者
- 多个镜像不可用 → 发送告警给系统管理员
- 缓存命中率<50% → 发送性能告警
- 存储后端异常 → 发送紧急告警

---

### UC-IMG-031: 镜像备份与恢复 (Image Backup and Recovery)

**参与者**: 系统管理员、自动化系统

**前置条件**:
- 备份系统已配置
- 有足够的备份存储空间

**基本流程**:

**自动备份**:
1. 系统按照备份策略执行备份：
   - **全量备份**: 每周日凌晨
   - **增量备份**: 每日凌晨
   - **差异备份**: 每小时（重要镜像）
2. 选择要备份的镜像：
   - 所有公共镜像
   - 标记为重要的私有镜像
   - 近期修改的镜像
3. 执行备份操作：
   - 导出镜像数据和元数据
   - 压缩备份文件
   - 计算备份哈希值
   - 传输到备份存储（异地）
   - 验证备份完整性
4. 更新备份记录
5. 清理过期备份（保留策略：7天内全部，30天内每周一份，1年内每月一份）
6. 生成备份报告

**手动备份**:
1. 管理员选择要备份的镜像
2. 选择备份类型（全量/增量）
3. 选择备份目标（本地/远程）
4. 触发备份任务
5. 监控备份进度
6. 验证备份结果

**灾难恢复**:
1. 检测到数据丢失或损坏
2. 管理员触发恢复流程
3. 选择恢复源：
   - 选择备份时间点
   - 选择备份位置
4. 选择恢复目标：
   - 原位置恢复
   - 新位置恢复
5. 执行恢复操作：
   - 下载备份文件
   - 验证完整性
   - 解压和还原数据
   - 恢复元数据
   - 重建索引
6. 验证恢复结果：
   - 测试镜像可用性
   - 验证数据完整性
   - 检查权限和配置
7. 恢复完成，服务恢复正常

**后置条件**:
- 镜像数据已安全备份
- 在灾难情况下可以快速恢复
- 数据丢失风险降低

**业务规则**:
- 系统默认镜像必须备份
- 备份数据加密存储
- 备份保留期：至少30天
- 异地备份：至少2个地理位置
- RTO（恢复时间目标）：<4小时
- RPO（恢复点目标）：<24小时

---

## 9. 镜像市场与协作 (Image Marketplace and Collaboration)

### UC-IMG-032: 镜像市场浏览 (Browse Image Marketplace)

**参与者**: 所有用户角色

**前置条件**:
- 镜像市场已启用
- 有公共镜像可用

**基本流程**:
1. 用户访问镜像市场页面
2. 系统展示镜像分类：
   - **操作系统**:
     - Linux（Ubuntu, CentOS, Debian等）
     - Windows（Windows 10, Windows 11, Windows Server）
   - **开发环境**:
     - Web开发（Node.js, PHP, Python）
     - 移动开发（Android Studio, Xcode）
     - 数据科学（Jupyter, TensorFlow, PyTorch）
   - **办公应用**:
     - 办公套件（Office, WPS）
     - 图形设计（Photoshop, Illustrator）
     - 视频编辑（Premiere, DaVinci Resolve）
   - **行业应用**:
     - 教育（电子教室）
     - 医疗（PACS工作站）
     - 金融（交易终端）
3. 提供搜索和过滤功能：
   - 关键词搜索
   - 按类别过滤
   - 按热度排序
   - 按评分排序
   - 按更新时间排序
4. 展示镜像卡片信息：
   - 镜像图标和名称
   - 简短描述
   - 评分和评论数
   - 下载次数
   - 价格（免费/付费）
   - 官方/认证标识
5. 用户点击镜像查看详情
6. 提供试用、下载、购买等操作

**后置条件**:
- 用户找到合适的镜像
- 可以快速部署应用

**扩展功能**:
- 推荐系统（基于使用历史）
- 镜像对比功能
- 用户评论和评分
- 镜像收藏夹

---

### UC-IMG-033: 发布镜像到市场 (Publish Image to Marketplace)

**参与者**: 开发者、ISV（独立软件供应商）

**前置条件**:
- 用户已通过身份认证和实名认证
- 镜像已上传并通过安全扫描
- 用户同意市场服务条款

**基本流程**:
1. 用户选择要发布的镜像
2. 填写市场发布信息：
   - **基本信息**:
     - 展示名称
     - 图标（256x256 PNG）
     - 简短描述（一句话）
     - 详细描述（支持Markdown）
     - 屏幕截图（至少3张）
     - 演示视频（可选）
   - **分类和标签**:
     - 主分类
     - 副分类
     - 标签（用于搜索）
   - **版本信息**:
     - 版本号
     - 更新日志
     - 系统要求
   - **定价策略**:
     - 免费/付费
     - 一次性购买/订阅制
     - 价格设置
     - 试用期设置
   - **技术支持**:
     - 支持邮箱
     - 文档链接
     - 支持热线
3. 提交审核
4. 系统执行审核流程：
   - **自动审核**:
     - 安全扫描必须通过
     - 镜像大小合理（<100GB）
     - 元数据完整
     - 图片和描述符合规范
   - **人工审核**:
     - 内容合规性检查
     - 功能验证
     - 价格合理性评估
5. 审核通过后发布到市场
6. 发送发布成功通知

**后置条件**:
- 镜像在市场中可见
- 其他用户可以购买/下载
- 发布者可以获得收益（如果付费）

**异常流程**:
- **E1**: 审核不通过 → 说明原因，允许修改后重新提交
- **E2**: 内容违规 → 拒绝发布，可能禁止账号

**业务规则**:
- 审核时间：3个工作日
- 发布者分成比例：70%（发布者）/ 30%（平台）
- 禁止发布含有恶意代码的镜像
- 禁止发布盗版软件

---

### UC-IMG-034: 镜像评论与评分 (Image Rating and Review)

**参与者**: 已使用过镜像的用户

**前置条件**:
- 用户已通过身份认证
- 用户已使用该镜像创建过实例
- 镜像在市场中公开

**基本流程**:

**提交评论**:
1. 用户打开镜像详情页
2. 点击"写评论"按钮
3. 填写评论信息：
   - 评分（1-5星）
   - 标题
   - 详细评论内容
   - 使用场景（可选）
   - 优点和缺点（可选）
   - 截图（可选）
4. 提交评论
5. 系统审核评论（自动+人工）：
   - 检测敏感词
   - 检测恶意评论
   - 验证用户确实使用过该镜像
6. 审核通过后发布评论
7. 更新镜像平均评分

**查看评论**:
1. 用户打开镜像详情页
2. 系统展示评论信息：
   - 平均评分和总评论数
   - 评分分布（5星x个，4星x个...）
   - 评论列表（按时间/评分排序）
3. 每条评论显示：
   - 评论者信息（用户名、头像）
   - 评分
   - 评论标题和内容
   - 评论时间
   - 有帮助按钮（点赞）
4. 提供过滤功能：
   - 只看高分评论
   - 只看低分评论
   - 只看有截图的评论

**评论互动**:
1. 其他用户可以对评论投票（有帮助/无帮助）
2. 镜像发布者可以回复评论
3. 用户可以编辑自己的评论
4. 用户可以删除自己的评论

**后置条件**:
- 评论帮助其他用户决策
- 镜像质量得到反馈
- 发布者可以改进镜像

**业务规则**:
- 每个用户对每个镜像只能评论一次
- 评论可以编辑，但需要重新审核
- 恶意评论会被删除，严重者封禁账号
- 评分影响镜像在市场的排名

---

### UC-IMG-035: 镜像协作开发 (Collaborative Image Development)

**参与者**: 开发团队成员

**前置条件**:
- 用户已通过身份认证
- 协作功能已启用
- 镜像支持协作（由所有者设置）

**基本流程**:

**创建协作项目**:
1. 镜像所有者创建协作项目
2. 设置协作配置：
   - 项目名称和描述
   - 协作成员列表
   - 成员角色和权限：
     - **Owner（所有者）**: 完全控制权
     - **Maintainer（维护者）**: 可以上传新版本、修改元数据
     - **Developer（开发者）**: 可以上传新版本
     - **Viewer（查看者）**: 只读访问
   - 工作流程：
     - 直接提交
     - 审查后提交
3. 邀请协作成员

**协作开发流程**:
1. 开发者基于现有镜像创建新分支（概念上）
2. 开发者修改和测试
3. 开发者上传新版本到协作项目
4. 如果需要审查：
   - 提交审查请求
   - Maintainer审查变更：
     - 查看差异
     - 测试新版本
     - 提供反馈意见
   - 审查通过后合并
5. 新版本发布
6. 通知所有协作成员

**变更追踪**:
1. 记录所有变更历史：
   - 谁做了什么修改
   - 何时修改
   - 为什么修改（commit message）
2. 支持变更比较和回滚
3. 生成变更报告

**后置条件**:
- 团队可以高效协作开发镜像
- 变更历史清晰可追溯
- 镜像质量提升

**业务规则**:
- 协作成员上限：50人
- 所有变更必须记录
- 重要变更需要审查
- 支持集成Git工作流

---

## 10. 高级功能 (Advanced Features)

### UC-IMG-036: 镜像增量更新 (Incremental Image Update)

**参与者**: 开发者、自动化系统、终端用户

**前置条件**:
- 镜像采用分层格式
- 增量更新功能已启用
- 终端已有旧版本镜像

**基本流程**:

**增量包生成**:
1. 开发者上传新版本镜像
2. 系统分析新旧版本差异：
   - 识别相同的层（基于哈希）
   - 识别新增的层
   - 识别修改的层
3. 生成增量更新包：
   - 只包含变化的层
   - 包含更新指令（如何组合层）
   - 生成增量包元数据
4. 计算增量包大小
5. 保存增量包

**增量更新**:
1. 终端检测到镜像有新版本
2. 查询是否有增量更新包可用
3. 如果可用：
   - 下载增量更新包（小文件，快速）
   - 验证本地旧版本
   - 应用增量更新：
     - 保留相同的层
     - 添加新增的层
     - 替换修改的层
     - 重建镜像manifest
   - 验证新版本完整性
4. 如果不可用：
   - 降级为全量下载

**后置条件**:
- 更新速度提升10倍以上
- 带宽消耗大幅减少
- 用户体验显著改善

**业务规则**:
- 仅patch和minor版本提供增量更新
- 增量包大小>50%全量时不生成（直接全量）
- 增量更新失败自动回退到全量更新

**典型场景**:
- **场景**: Windows 10镜像从v1909更新到v2004
- **全量大小**: 15GB
- **增量包大小**: 1.2GB
- **节省**: 92%带宽，更新时间从30分钟降到3分钟

---

### UC-IMG-037: 镜像智能推荐 (Intelligent Image Recommendation)

**参与者**: 所有用户角色、推荐系统

**前置条件**:
- 推荐系统已训练
- 有足够的用户行为数据

**基本流程**:

**数据收集**:
1. 系统持续收集用户行为数据：
   - 浏览历史
   - 下载历史
   - 使用时长
   - 评分和评论
   - 用户属性（角色、行业）
2. 收集镜像属性数据：
   - 分类和标签
   - 技术栈
   - 资源要求
   - 热度指标
3. 构建用户画像和镜像画像

**推荐生成**:
1. 用户登录系统
2. 推荐引擎分析用户画像
3. 应用多种推荐算法：
   - **协同过滤**: 找到相似用户喜欢的镜像
   - **内容推荐**: 基于用户历史推荐相似镜像
   - **热度推荐**: 推荐当前热门镜像
   - **新品推荐**: 推荐最新发布的镜像
   - **补足推荐**: 推荐用户缺少的关键镜像
4. 综合多个算法结果
5. 生成个性化推荐列表
6. 展示推荐结果，说明推荐理由

**推荐展示位置**:
- 首页推荐位
- 镜像详情页"相关推荐"
- 搜索结果"猜你喜欢"
- 用户工作台"为你推荐"

**推荐优化**:
1. 收集用户对推荐的反馈：
   - 点击率
   - 下载率
   - 满意度（隐式反馈）
2. 持续优化推荐模型
3. A/B测试不同推荐策略

**后置条件**:
- 用户发现镜像更容易
- 镜像使用率提升
- 用户满意度提高

**推荐示例**:
```
为您推荐：

1. Ubuntu Desktop 22.04 开发版
   推荐理由：您经常使用Ubuntu，这是最新LTS版本

2. PyTorch深度学习环境
   推荐理由：与您已使用的TensorFlow环境类似

3. Visual Studio Code集成环境
   推荐理由：90%使用Python开发的用户也使用此镜像

4. Android开发环境（新）
   推荐理由：刚发布，适合移动开发
```

---

### UC-IMG-038: 镜像格式转换 (Image Format Conversion)

**参与者**: 用户、自动化系统

**前置条件**:
- 源镜像存在
- 转换工具已安装

**基本流程**:
1. 用户选择要转换的镜像
2. 选择目标格式：
   - **qcow2** ↔ **raw**
   - **qcow2** ↔ **vmdk**
   - **qcow2** ↔ **vhd/vhdx**
   - **raw** ↔ **vmdk**
3. 选择转换选项：
   - 压缩（是/否）
   - 加密（是/否）
   - 目标存储位置
4. 系统执行转换：
   - 验证源镜像完整性
   - 使用qemu-img或类似工具转换
   - 显示转换进度
   - 验证转换后的镜像
5. 保存转换后的镜像
6. 更新镜像元数据
7. 返回成功响应

**后置条件**:
- 生成新格式的镜像
- 原镜像保留
- 新镜像可以正常使用

**异常流程**:
- **E1**: 格式不支持 → 返回错误提示
- **E2**: 转换失败 → 清理临时文件，返回错误
- **E3**: 空间不足 → 提示清理空间

**业务规则**:
- 转换过程中原镜像不受影响
- 转换后的镜像自动继承原镜像的权限
- 大文件转换在后台队列中执行

**性能优化**:
- 并行转换多个镜像
- 使用专用硬件加速（如果可用）
- 转换过程中的临时文件及时清理

---

### UC-IMG-039: 镜像快照管理 (Image Snapshot Management)

**参与者**: 开发者、系统管理员

**前置条件**:
- 镜像格式支持快照（如qcow2）
- 用户有权限操作镜像

**基本流程**:

**创建快照**:
1. 用户选择正在使用的镜像（通常是运行中的实例）
2. 点击"创建快照"
3. 填写快照信息：
   - 快照名称
   - 快照描述
   - 快照类型：
     - **崩溃一致性**: 不暂停虚拟机，快速但可能不一致
     - **应用一致性**: 暂停虚拟机，确保数据一致
4. 系统创建快照：
   - 暂停虚拟机I/O（如果需要）
   - 创建镜像快照
   - 保存快照元数据
   - 恢复虚拟机运行
5. 快照创建完成
6. 快照可用于恢复或创建新镜像

**查看快照列表**:
1. 用户打开镜像详情页
2. 切换到"快照"标签
3. 系统显示快照列表：
   - 快照名称
   - 创建时间
   - 快照大小
   - 快照描述
   - 快照状态
4. 提供快照搜索和排序功能

**从快照恢复**:
1. 用户选择快照
2. 点击"恢复"
3. 确认恢复操作（警告：当前数据会丢失）
4. 系统执行恢复：
   - 停止使用该镜像的实例
   - 恢复到快照状态
   - 重启实例
5. 恢复完成

**从快照创建新镜像**:
1. 用户选择快照
2. 点击"创建镜像"
3. 填写新镜像信息
4. 系统基于快照创建新镜像
5. 新镜像可独立使用

**删除快照**:
1. 用户选择快照
2. 点击"删除"
3. 系统检查快照是否被使用
4. 确认删除
5. 删除快照数据
6. 更新快照链

**后置条件**:
- 可以回到镜像的历史状态
- 支持快速备份和恢复
- 降低数据丢失风险

**业务规则**:
- 每个镜像最多64个快照
- 快照占用增量空间（只存储差异）
- 删除快照可能影响子快照
- 快照链深度影响性能

**典型应用场景**:
- 开发测试：每次重大修改前创建快照
- 升级保护：软件升级前创建快照，失败时快速回滚
- 实验环境：创建快照后进行高风险操作

---

## 11. 镜像合规与审计 (Image Compliance and Audit)

### UC-IMG-040: 镜像合规检查 (Image Compliance Check)

**参与者**: 合规管理员、自动化系统

**前置条件**:
- 合规策略已配置
- 合规检查工具已部署

**基本流程**:

**配置合规策略**:
1. 合规管理员登录系统
2. 配置合规规则：

   **许可证合规**:
   - 禁止的许可证类型（如GPL用于商业软件）
   - 必须的许可证声明

   **安全合规**:
   - 最大允许漏洞数量
   - 禁止的漏洞类型
   - 必须的安全基线

   **数据合规**:
   - 禁止包含敏感数据（个人信息、密钥等）
   - 数据存储位置限制（如GDPR要求）

   **技术合规**:
   - 禁止的软件包列表
   - 必须的软件包列表
   - 配置基线要求

   **行业合规**:
   - 等保要求（如等保2.0三级）
   - HIPAA（医疗）
   - PCI-DSS（金融）
   - SOC 2

3. 保存合规策略

**合规检查执行**:
1. 镜像上传或更新时自动触发检查
2. 系统执行合规扫描：

   **许可证扫描**:
   - 提取所有软件包
   - 识别每个包的许可证
   - 对照禁止列表检查

   **安全扫描**:
   - 执行漏洞扫描
   - 检查是否符合安全基线
   - 检查配置安全性

   **敏感数据扫描**:
   - 扫描文件系统查找敏感信息模式：
     - 密钥（private keys）
     - 密码
     - API令牌
     - 个人身份信息（PII）
   - 检查数据存储位置

   **配置合规扫描**:
   - 检查系统配置
   - 验证安全设置（如防火墙规则）
   - 检查日志配置

3. 生成合规报告：
   - 合规项目列表
   - 不合规项目列表
   - 严重程度分级
   - 修复建议
4. 根据结果决定镜像状态：
   - **合规**: 允许发布和使用
   - **警告**: 可以使用但显示警告
   - **不合规**: 禁止发布和使用

**合规报告**:
1. 用户查看镜像合规报告
2. 系统显示详细信息：
   - 合规概览（通过/警告/失败）
   - 许可证清单
   - 安全评估结果
   - 不合规项详情
   - 修复建议
3. 提供导出功能（PDF报告）

**后置条件**:
- 确保镜像符合法规要求
- 降低法律和安全风险
- 提供审计证据

**业务规则**:
- 不合规镜像不能发布到生产环境
- 合规检查每周自动重新执行（法规可能更新）
- 合规报告保留至少3年

---

## 总结

本文档详细描述了镜像管理系统的40个核心用例，涵盖：

**功能领域**:
1. **生命周期管理**: 上传、下载、删除、更新
2. **版本管理**: 多版本、标签、回滚
3. **权限控制**: 可见性、授权、访问控制
4. **安全管理**: 扫描、内容信任、策略
5. **存储分发**: 去重、缓存、P2P、同步
6. **模板管理**: 创建模板、部署实例
7. **集成自动化**: CI/CD、API、通知
8. **监控运维**: 统计、健康检查、备份恢复
9. **市场协作**: 市场、评论、协作开发
10. **高级功能**: 增量更新、智能推荐、格式转换、快照
11. **合规审计**: 合规检查、审计报告

**关键特性**:
- 完整的镜像生命周期管理
- 强大的安全和权限控制
- 高效的存储和分发机制
- 丰富的协作和市场功能
- 全面的监控和审计能力

这些用例为镜像管理系统的开发和实施提供了详细的功能规范和业务逻辑参考。
