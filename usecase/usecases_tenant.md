# 租户管理用例文档 (Tenant Management Use Cases)

## 目录
- [1. 租户生命周期管理](#1-租户生命周期管理)
- [2. 租户配额管理](#2-租户配额管理)
- [3. 租户用户管理](#3-租户用户管理)
- [4. 租户用户组管理](#4-租户用户组管理)

---

## 1. 租户生命周期管理

### UC-TENANT-001: 创建租户 (Create Tenant)

**参与者**: 系统管理员（超级管理员，admin角色）

**前置条件**:
- 系统管理员已登录系统
- 系统管理员具有创建租户权限
- 系统中有可用的VLAN ID用于网络隔离

**基本流程**:
1. 系统管理员选择"创建租户"功能
2. 系统显示租户创建表单
3. 系统管理员输入以下信息:
   - 租户名称（必填，唯一）
   - 租户描述（可选）
   - 租户管理员选择:
     - 选项A: 选择现有用户作为租户管理员
       - 从用户列表中选择用户
       - 系统验证用户存在且未属于其他租户
     - 选项B: 创建新用户作为租户管理员
       - 输入用户名、邮箱、密码
       - 系统自动创建用户并设置为租户管理员
   - 网络隔离配置:
     - VLAN ID（可选，系统自动分配或手动指定）
     - 如果不指定，系统自动分配唯一的VLAN ID
   - 配额设置（必填）:
     - 最大实例数 (max_instances)
     - 最大CPU核心数 (max_cpu_cores)
     - 最大内存容量 (max_memory_gb)
     - 最大存储容量 (max_storage_gb)
     - 最大私有数据盘容量 (max_private_data_disk_gb)
     - 最大IP地址数 (max_ip_addresses)
     - 最大网络带宽 (max_bandwidth_gbps)
4. 系统验证输入信息:
   - 租户名称唯一性检查
   - 如果选择现有用户，验证用户未属于其他租户
   - VLAN ID唯一性检查（如果手动指定）
   - 配额值合法性检查（必须为正整数）
5. 系统创建租户记录:
   - 生成租户ID (tenant_id)
   - 设置租户状态为 "active"
   - 保存租户基本信息和配额配置
   - 分配VLAN ID
   - 记录创建者（当前系统管理员）
6. 如果选择创建新用户:
   - 创建用户账户，设置role为 "tenant_admin"
   - 将用户关联到新创建的租户 (tenant_id)
7. 如果选择现有用户:
   - 更新用户role为 "tenant_admin"
   - 将用户关联到新创建的租户 (tenant_id)
8. 系统返回租户ID和创建成功信息

**后置条件**:
- 新租户记录已保存到数据库
- 租户状态为 "active"
- 租户管理员已设置并关联到租户
- 租户已分配唯一的VLAN ID
- 租户配额已配置

**异常流程**:
- 4a. 如果租户名称重复:
  - 系统提示名称已存在
  - 返回步骤3
- 4b. 如果选择的现有用户已属于其他租户:
  - 系统提示用户已属于其他租户
  - 返回步骤3，提示选择其他用户或创建新用户
- 4c. 如果VLAN ID已被占用（手动指定时）:
  - 系统提示VLAN ID冲突
  - 返回步骤3，提示选择其他VLAN ID或使用自动分配
- 4d. 如果配额值不合法:
  - 系统提示配额值必须为正整数
  - 返回步骤3

**业务规则**:
- 租户名称在系统内必须唯一
- 每个租户必须有一个管理员
- 租户管理员自动获得 "tenant_admin" 角色
- VLAN ID自动分配时，系统确保唯一性
- 租户配额限制租户内所有用户和用户组的总资源使用

---

### UC-TENANT-002: 查看租户详情 (View Tenant Details)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户查看权限
- 系统中存在至少一个租户

**基本流程**:
1. 用户选择"租户列表"功能
2. 系统显示租户列表:
   - 系统管理员可以看到所有租户
   - 租户管理员只能看到自己管理的租户
3. 用户选择要查看的租户
4. 系统显示租户详细信息:
   - 基本信息（名称、描述、状态、创建时间）
   - 租户管理员信息
   - 网络配置（VLAN ID）
   - 配额配置（各类资源配额）
   - 配额使用情况（已用/总量）
   - 租户内用户列表
   - 租户内用户组列表
   - 租户内VPC列表
5. 用户可以查看各项统计数据和图表

**后置条件**:
- 用户获得租户详细信息

**权限说明**:
- 系统管理员可以查看所有租户的详细信息
- 租户管理员只能查看自己租户的详细信息

---

### UC-TENANT-003: 更新租户信息 (Update Tenant Information)

**参与者**: 系统管理员（超级管理员）

**前置条件**:
- 系统管理员已登录系统
- 系统管理员具有租户管理权限
- 目标租户存在

**基本流程**:
1. 系统管理员选择要更新的租户
2. 系统显示租户编辑表单
3. 系统管理员修改以下信息:
   - 租户名称（唯一性检查）
   - 租户描述
   - 租户状态 (active, inactive, suspended)
4. 系统验证修改信息:
   - 如果修改名称，检查唯一性
   - 如果修改状态为 suspended，验证租户内无运行中的实例
5. 系统更新租户记录
6. 如果状态变更为 suspended:
   - 系统停止租户内所有运行中的实例
   - 冻结租户资源
7. 系统返回更新成功信息

**后置条件**:
- 租户信息已更新
- 如果状态变更，相关资源状态已同步更新

**异常流程**:
- 4a. 如果租户名称重复:
  - 系统提示名称已存在
  - 返回步骤3
- 4b. 如果修改状态为 suspended 但租户内有运行中的实例:
  - 系统提示无法暂停，需要先停止所有实例
  - 返回步骤3

---

### UC-TENANT-004: 删除租户 (Delete Tenant)

**参与者**: 系统管理员（超级管理员）

**前置条件**:
- 系统管理员已登录系统
- 系统管理员具有租户删除权限
- 目标租户存在
- 租户内无运行中的实例和资源

**基本流程**:
1. 系统管理员选择要删除的租户
2. 系统显示租户删除确认对话框
3. 系统管理员确认删除操作
4. 系统验证租户是否可以删除:
   - 检查租户内是否有运行中的实例
   - 检查租户内是否有未删除的资源
   - 检查租户内是否有未删除的VPC
5. 系统执行删除操作:
   - 删除租户内所有用户组
   - 删除租户内所有用户（或标记为已删除）
   - 删除租户内所有VPC和相关网络资源
   - 删除租户记录
6. 系统返回删除成功信息

**后置条件**:
- 租户及其所有关联资源已删除

**异常流程**:
- 4a. 如果租户内有运行中的实例:
  - 系统提示无法删除，需要先删除所有实例
  - 取消删除操作
- 4b. 如果租户内有未删除的资源:
  - 系统提示无法删除，需要先清理所有资源
  - 取消删除操作

---

## 2. 租户配额管理

### UC-TENANT-005: 更新租户配额 (Update Tenant Quota)

**参与者**: 系统管理员（超级管理员）

**前置条件**:
- 系统管理员已登录系统
- 系统管理员具有租户配额管理权限
- 目标租户存在

**基本流程**:
1. 系统管理员选择要更新配额的租户
2. 系统显示租户配额配置表单
3. 系统管理员修改配额值:
   - 最大实例数
   - 最大CPU核心数
   - 最大内存容量
   - 最大存储容量
   - 最大私有数据盘容量
   - 最大IP地址数
   - 最大网络带宽
4. 系统验证修改后的配额:
   - 检查新配额是否小于当前租户的资源使用量
   - 如果小于，提示警告但允许继续（允许超标）
5. 系统更新租户配额配置
6. 如果配额降低且当前使用量超过新配额:
   - 系统标记租户为配额超标状态
   - 禁止租户内用户创建新资源
   - 通知租户管理员
7. 系统返回更新成功信息

**后置条件**:
- 租户配额已更新
- 如果配额超标，租户状态已标记

**异常流程**:
- 4a. 如果配额值不合法:
  - 系统提示配额值必须为正整数
  - 返回步骤3

**业务规则**:
- 配额降低时，如果当前使用量超过新配额，允许更新但标记为超标状态
- 配额超标时，禁止创建新资源，但允许现有资源继续运行

---

### UC-TENANT-006: 查看租户配额使用情况 (View Tenant Quota Usage)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户查看权限
- 目标租户存在

**基本流程**:
1. 用户选择要查看的租户
2. 系统显示租户配额使用情况:
   - 各类资源的使用量/配额
   - 使用率百分比
   - 剩余可用配额
   - 配额使用趋势图表
   - 各用户组的配额使用情况
   - 各用户的配额使用情况
3. 用户可以查看详细的使用统计

**后置条件**:
- 用户获得租户配额使用情况信息

---

## 3. 租户用户管理

### UC-TENANT-007: 创建租户用户 (Create Tenant User)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户用户管理权限
- 目标租户存在

**基本流程**:
1. 用户选择要管理的租户
2. 用户选择"创建用户"功能
3. 系统显示用户创建表单
4. 用户输入以下信息:
   - 用户名（必填，唯一）
   - 邮箱（必填）
   - 密码（必填）
   - 角色 (user, operator)
   - 所属用户组（可选，可多选）
   - 用户配额（可选）
5. 系统验证输入信息:
   - 用户名唯一性检查
   - 邮箱格式验证
   - 密码强度验证
6. 系统创建用户记录:
   - 生成用户ID
   - 设置用户所属租户 (tenant_id)
   - 设置用户角色和状态
   - 如果指定了用户组，建立用户组关联关系
   - 如果指定了用户配额，设置用户配额
7. 系统返回用户ID和创建成功信息

**后置条件**:
- 新用户已创建并关联到租户
- 用户已添加到指定的用户组（如果指定）

**权限说明**:
- 系统管理员可以为任何租户创建用户
- 租户管理员只能为自己管理的租户创建用户

---

### UC-TENANT-008: 管理租户用户列表 (Manage Tenant Users)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户用户管理权限
- 目标租户存在

**基本流程**:
1. 用户选择要管理的租户
2. 系统显示租户内用户列表
3. 用户可以进行以下操作:
   - 查看用户详情
   - 编辑用户信息
   - 禁用/启用用户
   - 重置用户密码
   - 删除用户
   - 管理用户所属用户组
4. 用户选择操作并执行
5. 系统执行相应操作并返回结果

**后置条件**:
- 用户操作已执行
- 用户列表已更新

---

## 4. 租户用户组管理

### UC-TENANT-009: 创建租户用户组 (Create Tenant User Group)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户用户组管理权限
- 目标租户存在

**基本流程**:
1. 用户选择要管理的租户
2. 用户选择"创建用户组"功能
3. 系统显示用户组创建表单
4. 用户输入以下信息:
   - 用户组名称（必填，租户内唯一）
   - 用户组描述（可选）
   - 父用户组（可选，支持层级结构）
   - 用户组配额（可选）
5. 系统验证输入信息:
   - 用户组名称在租户内唯一性检查
   - 如果指定父用户组，验证父用户组属于同一租户
6. 系统创建用户组记录:
   - 生成用户组ID
   - 设置用户组所属租户 (tenant_id)
   - 如果指定了父用户组，建立父子关系
   - 如果指定了用户组配额，设置用户组配额
7. 系统返回用户组ID和创建成功信息

**后置条件**:
- 新用户组已创建并关联到租户
- 用户组已建立层级关系（如果指定）

**权限说明**:
- 系统管理员可以为任何租户创建用户组
- 租户管理员只能为自己管理的租户创建用户组

---

### UC-TENANT-010: 管理租户用户组成员 (Manage Tenant User Group Members)

**参与者**: 系统管理员（超级管理员）、租户管理员

**前置条件**:
- 用户已登录系统
- 用户具有租户用户组管理权限
- 目标租户和用户组存在

**基本流程**:
1. 用户选择要管理的租户
2. 用户选择要管理的用户组
3. 系统显示用户组成员列表
4. 用户可以进行以下操作:
   - 添加成员: 从租户内用户列表中选择用户添加到组
   - 移除成员: 从组中移除用户
   - 批量操作: 批量添加或移除成员
5. 系统验证操作:
   - 验证用户属于同一租户
   - 验证用户组属于同一租户
6. 系统执行操作并更新用户组成员关系
7. 系统返回操作结果

**后置条件**:
- 用户组成员关系已更新

**业务规则**:
- 一个用户可以在多个用户组
- 用户和用户组必须属于同一租户

---

