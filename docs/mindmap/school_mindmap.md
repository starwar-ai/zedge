# 云电脑业务管理系统

## 领域对象

### 机房

- 状态
  
    - 正常
      
    - 运维中
      
    - 已关闭
      
- 资源
  
    - 服务器
      
    - 主机
      
        - 资源
          
            - cpu资源
              
                - 可用
                  
                - 已用
                  
            - 磁盘资源
              
                - 可用
                  
                - 已用
                  
            - gpu资源
              
                - 可用
                  
                - 已用
                  
    - 存储
      
        - 虚拟盘资源
          
        - 文件资源
          
    - 开关
      
    - 网关
      
    - 其他设备
      
- 其他属性
  
    - 机房名称
      
    - 机房id
      
    - 机房位置
      
        - 行政区划
          
        - 详细地址
          
    - 主机数量
      
    - 资源统计
      
        - cpu
          
        - gpu
          
        - 内存
          
        - 硬盘
          
    - 实例统计
      
    - 创建日期
      
- 操作
  
    - 创建
      
    - 关闭
      
    - 删除
      
    - 编辑
      
    - 开启
      
### 虚机实例

- 状态
  
    - 已创建
      
    - 已计划
      
    - 开机中
      
    - 运行中
      
    - 关机中
      
    - 已关机
      
    - 已销毁
      
- 其他属性
  
    - 健康状况
      
    - id
      
    - 名称
      
    - 规格详情
      
    - 本地磁盘
      
    - 释放时间
      
- 操作
  
    - 创建
      
        - 按计划创建
          
            - 根据最新导入课表，创建实例
              
            - 取消或调整计划
              
        - 临时创建
          
        - 设置租用方式
          
            - 固定时长，到时自动销毁
              
            - 长时间租用，按时间扣费，费用不足提醒，超过期限未充值，自动销毁
              
        - 创建时，检查场所，用户在时间是否有资源冲突
          
        - 是否按比例分配？
          
    - 列表
      
        - 查看实例列表，实例创建计划
          
    - 保存镜像
      
        - 保存系统盘，但不保存数据盘
          
    - 加载镜像
      
    - 到期释放与预警
      
    - 升降配
      
        - 查看主机可分配资源（cpu，gpu，内存，数据盘）
          
    - 重置
      
        - 系统盘也会重置
          
    - 替换镜像
      
    - 实例迁移
      
        - 系统盘
          
        - 数据盘
          
    - 开关机
      
        - 无卡开机
          
    - 设置名称
      
### 模板

- 分类
  
    - 公共模板
      
    - 私有模板
      
- 其他属性
  
    - 模板编号
      
    - 用途
      
    - 操作系统
      
    - 使用镜像
      
    - 模板名称
      
    - 私有模板需要指定所有者
      
    - 适用配置
      
        - cpu核心数
          
        - gpu
          
        - 内存
          
        - 磁盘
          
    - 挂载磁盘
      
- 操作
  
    - 创建
      
        - 设置用途， os镜像，挂载磁盘
          
### 主机

- 分类
  
    - CPU服务器
      
    - PCFarm
      
        - CPU服务器
          
    - GPU服务器
      
- 状态
  
    - 运行中
      
    - 维护中
      
    - 已下线
      
- 资源
  
    - CPU
      
        - 核心数
          
    - GPU
      
        - 卡数
          
        - 显存
          
    - 硬盘
      
        - 容量GB
          
    - 内存
      
        - 容量GB
          
    - 剩余可用资源
      
- 其他属性
  
    - 所属机房
      
    - 所属资源池
      
    - 主机uuid
      
    - 主机编号
      
    - 驱动
      
    - cuda
      
    - 细分主题 7
      
- 主机可租用期限
  
- 管理
  
    - 增删改查
      
### 镜像

- 分类
  
    - 公有镜像
      
    - 私有镜像
      
        - 基础镜像信息
          
- 预装软件
  
    - 名称
      
    - 版本
      
    - 安装路径
      
- 其他属性
  
    - 大小
      
    - 状态
      
        - 上架/下架
          
    - 名称
      
    - 创建时间
      
    - 操作系统
      
    - 私有镜像需要指定所有者
      
    - 当前版本
      
    - 缓存地区
      
    - 基础镜像信息
      
- 最低配置要求
  
    - cpu核心数
      
    - 内存
      
    - 磁盘空间
      
- 操作
  
    - 增删改查
      
        - 镜像提交后，需要审核才能上架
          
    - 共享镜像
      
    - 上/下架
      
### 存储

- 分类
  
    - 磁盘
      
        - 公共磁盘
          
            - 公开数据集，自动加载到实例
              
                - 只读
                  
        - 私有磁盘
          
            - 只读
              
                - 可以共享给他人或者组内共享
                  
            - 可写
              
            - (empty)
              
    - 文件
      
- 磁盘
  
    - 类型
      
        - ssd/nvme/
          
    - 公共磁盘
      
        - 名称
          
        - 实例中路径
          
        - 类型
          
            - 数据集
              
        - 发布房
          
        - 简介
          
    - 私有磁盘
      
        - 所有者
          
- 其他属性
  
    - 大小
      
- 操作
  
    - 创建
      
        - 实例基础数据盘
          
            - 使用主机磁盘
              
        - 扩展数据盘
          
            - 使用ceph
              
    - 外部网盘的文件上传下载
      
### 用户

- 用户组管理
  
    - 院校
      
        - 专业
          
            - 设置最低和推荐硬件资源配置
              
            - 年级
              
                - 班级
                  
    - group managers 管理组
      
- 用户
  
    - 管理
      
        - 增删改查
          
- 角色
  
    - 分类
      
        - 教师
          
        - 学生
          
        - 教务
          
        - IT
          
    - 管理
      
        - 增删改查
          
- 配额
  
### 租户

- 配额
  
    - 过期时间
      
    - 配额数量
      
### 资源池

- 分类
  
    - gpu主机
      
        - N卡
          
        - A卡
          
        - H卡
          
        - 细分主题 4
          
    - cpu主机
      
- 状态
  
    - 已关闭
      
    - 正常
      
### 计费规则

- 要素
  
    - 机房
      
        - 不同机房与标准价格有不同
          
    - gpu
      
        - 不同品牌（N卡，A卡，华为，玄武纪）
          
        - 不同型号（3090, )
          
        - 数量
          
    - 内存
      
        - 按容量计费
          
    - cpu
      
        - 按核心数计费
          
    - 存储
      
        - 有免费额度，超过收费 
          
            - 0.01/GB/日
              
- 计费方式
  
    - 按量/包日/包周/包月单价
      
    - 按量记费和包时间计费，可以互相转换
      
        - 包时长转按量计费
          
            - 满周，按周单价计算
              
            - 满日，按日单价计算
              
- 场景
  
    - 学校等租户场景，不支持包日/包月方式
      
### 配额

- 学校配额
  
    - 总积分有时间限制，比如一个学期，过期作废
      
    - 系统能根据实验室排课表，自动计算出所需积分
      
    - 计划实例与扣费
      
        - 筛选需要用到实训室的课程
          
        - 设置上课模板
          
        - 自动计算所需实例数，以及耗费积分
          
        - 如果已经锁定了资源，需要调整时间或者取消预定，可以退还积分，但要扣除一定的费用
          
        - 上课前，老师可以临时增加或删除实例。新增实例要用学校积分
          
- 用户配额
  
    - 平台可以给用户一定的免费积分
      
    - 积分都有时间限制，如一个月，过期会作废
      
### 费用

- 订单
  
    - 状态
      
        - 已支付
          
        - 未支付
          
        - 已取消
          
    - 订单类型
      
        - 新实例购买
          
        - 新文件存储购买
          
        - 新数据盘购买
          
        - 镜像存储购买
          
    - 其他属性
      
        - 订单编号
          
        - 创建时间
          
        - 支付时间
          
        - 产品名称
          
        - 计费方式
          
            - 按量计费
              
            - 包日，包月，包年
              
- 收支明细
  
    - 流水号
      
    - 交易时间
      
    - 交易类型
      
        - 支出/收入
          
    - 支付方式
      
        - 积分
          
        - 微信
          
        - 支付宝
          
    - 账户余额
      
    - 备注
      
        - 实例id等购买信息
          
- 账单明细
  
    - 交易类型
      
        - 消费
          
        - 退款
          
    - 按日
      
        - 日期
          
        - 交易类型
          
        - 交易金额
          
        - 优惠金额
          
        - 积分支付
          
    - 明细
      
        - 流水号
          
        - 交易时间
          
        - 交易类型
          
        - 原价
          
        - 交易金额
          
        - 产品名称
          
        - 优惠金额
          
        - 积分支付
          
        - 订单号
          
        - 计费周期
          
        - 计费时长
          
## 用例

### 学校场景

- 用户注册
  
    - 点击注册
      
    - 通过学员号/教职工号绑定
      
    - 跳转学校系统授权页面
      
    - 跳转onelink注册页面
      
    - 输入手机号/邮箱地址
      
    - 检查是否已经存在用户
      
        - 存在时，与已有账户绑定
          
        - 不存在时，新建用户，并绑定
          
    - 验证手机号/邮箱地址
      
    - 设置登录密码
      
    - 完成注册，跳转登录页面
      
        - 创建onlink用户id，并与学校系统用户id绑定
          
- 用户登录
  
    - 跳转学校系统登录界面
      
    - 输入学员号/教职工号
      
    - 输入密码
      
        - 忘记密码时，点击重置密码
          
    - 通过onelink回调接口，获取token，onelink用户id
      
    - 进入首页
      
- 学员/教职工同步
  
    - 每10分钟同步一次
      
    - 检查学员/教职工是否需要更新
      
        - onelink里如果没有则新建用户
          
        - 将新建用户加入学校租户下
          
        - 设置学员和教职工用户的角色，可以兼具两种角色
          
        - 无效的学员/教职工，在onelink里的账户仍然有效，但已退出学校租户。
          
    - 检查院系/专业/年级/班级/小组是否需更新
      
        - onelink里，如果没有对应，则创建用户分组
          
        - 一个用户可以属于多个分组
          
        - 学校系统中无效的，或者已删除的分组，在onelink里设置成无效
          
- 临时上课
  
    - 老师事先将本次课程用到的实例创建完毕
      
    - 学生/老师到实验室，用学员号/教职工号登录
      
    - 学生在desk客户端选择实例，点击进入
      
    - 系统自动将学生/老师的个人数据盘加载到自己的实例里
      
    - 下课时，如果学员需要继续使用，可以手动停止实例，选择保存镜像（只保存系统盘，不保存数据盘）
      
    - 下课，一定时间后（10分钟），系统自动停止实例，并在更长一段时间（30分钟）后销毁实例
      
    - 学员下课后如果希望继续练习，可以用保存的镜像重新创建实例。
      
    - 如果希望实例中间不要停机，可以选择直接租用该实例。学员/老师需要从账户上扣除费用。费用=单价*时长。也可以按日/月付费。
      
- 按课表上课
  
    - 为实训课，选择所需的模板
      
    - 根据模板，自动匹配主机
      
    - 设置预计使用开始和结束时间
      
    - 锁定主机资源
      
    - 上课前10分钟，系统开始自动创建实例
      
    - 上课前5分钟，系统开始运行实例
      
    - 学生/老师到实验室，用学员号/教职工号登录
      
    - 学生在desk客户端选择实例，点击进入
      
    - 系统自动将学生/老师的个人数据盘加载到自己的实例里
      
    - 下课时，如果学员需要继续使用，可以手动停止实例，选择保存镜像（只保存系统盘，不保存数据盘）
      
    - 下课，一定时间后（10分钟），系统自动停止实例，并在更长一段时间（30分钟）后销毁实例
      
    - 学员下课后如果希望继续练习，可以用保存的镜像重新创建实例。
      
    - 如果希望实例中间不要停机，可以选择直接租用该实例。学生/老师需要从账户上扣除费用。费用=单价*时长。也可以按日/月付费。
      
### 申请退款

- 打开订单（只能针对包时长订单进行退款）
  
- 退款申请到后台
  
- 确认是否可以退款
  
- 后台运营同意
  
- 自动释放/回收资源
  
    - 实例
      
- 完成退款
  
### 从镜像创建实例

- 进入镜像列表
  
- 选择镜像
  
- 点击创建实例
  
- 打开创建实例页面
  
- 自动选中镜像，不可编辑
  
- 点击创建
  
### 从模板创建实例

- 进入模板列表
  
- 选择模板
  
- 点击创建实例
  
### 细分主题 5

## 界面

### 实例管理

- 实例列表
  
    - 功能描述：展示所有云电脑实例
      
    - 页面元素：
      
        - 标签页
          
            - 个人实例
              
            - 团队实例
              
        - 搜索条件
          
            - 实例名称
              
            - 实例状态
              
            - 创建时间范围
              
            - 到期时间范围
              
            - 释放时间范围
              
        - 列表字段
          
            - 实例id
              
            - 实例名称
              
                - 可以修改实例名称
                  
            - 所属用户（姓名，手机号后4位）
              
            - 状态
              
            - 配置详情
              
                - 操作系统
                  
                - cpu，内存
                  
            - 所属机房
              
            - 所属主机
              
            - 创建时间
              
            - 到期时间
              
            - 释放时间
              
            - 计费方式
              
                - 时
                  
                - 日
                  
                - 月
                  
            - 操作：
              
                - 开启状态
                  
                    - 关机
                      
                - 关闭状态
                  
                    - 开机
                      
                    - 保存镜像
                      
                    - 升降配
                      
                        - 调整内存，cpu
                          
                    - 数据盘扩缩容
                      
        - 批量操作
          
            - 开/关机，重启
              
            - 释放实例
              
    - 交互说明：
      
        - 实例状态实时刷新（每30秒自动刷新）
          
        - 所有操作需二次确认，危险操作（释放）需输入实例ID确认
          
    - 权限要求：
      
        - 查看自己创建的实例
          
        - 查看属于自己管理的用户的实例
          
- 实例详情
  
    - 功能描述：显示云电脑的详情
      
    - 基础信息块：
      
        - 实例id
          
        - 实例名称
          
        - 所属用户（姓名，手机号后4位）
          
        - 状态
          
        - 配置详情
          
            - 操作系统
              
            - cpu，内存
              
        - 所属机房
          
        - 所属主机
          
        - 创建时间
          
        - 用途
          
        - 到期时间
          
        - 释放时间
          
        - 计费方式
          
    - 实时监控块：
      
        - 内存使用率
          
        - cpu使用率
          
        - 显存使用率
          
        - gpu使用率
          
        - 系统盘用量
          
        - 数据盘用量
          
    - 磁盘信息块
      
        - 挂载点
          
        - 磁盘类型
          
            - 系统盘
              
            - 数据盘
              
                - 私有数据盘
                  
                - 公有数据盘
                  
        - 磁盘容量
          
        - 读写
          
            - 只读
              
            - 可写
              
    - 镜像信息块
      
        - 镜像编号
          
        - 镜像名称
          
        - 镜像类型
          
        - 镜像大小
          
        - 镜像描述
          
    - 运行记录
      
        - 开机时间
          
        - 关机时间
          
        - 使用时长
          
        - 单价
          
        - 计费方式
          
        - 操作人
          
        - 消耗积分
          
    - 操作：
      
        - 开启状态
          
            - 关机
              
        - 关闭状态
          
            - 开机
              
            - 保存镜像
              
            - 升降配
              
                - 调整内存，cpu
                  
            - 数据盘扩缩容
              
- 创建个人实例
  
    - 功能描述：按新建按钮，创建新实例
      
    - 表单内容
      
        - 选择用途
          
            - AI训练
              
            - 图形处理
              
            - 普通办公
              
        - 选择模板
          
            - 根据用途筛选模板
              
        - 选择机房
          
        - 选择配置
          
            - GPU
              
                - 要显示gpu的类型/可用数量
                  
                - 选择GPU数量
                  
            - CPU
              
            - 内存
              
            - 分配约束
              
                - 用GPU：GPU/CPU/内存的比例 1:8:32
                  
                - 只用CPU：cpu和内存可以根据需要自己调配
                  
        - 选择数据盘容量
          
            - 默认50G
              
            - 可以增加，但需要额外收费
              
        - 设置使用时长
          
        - 选择主机
          
            - 根据配置，在主机池中选择可以满足条件的主机。
              
            - 列表显示
              
                - 主机id
                  
                - gpu型号/显存
                  
                - 驱动/cuda
                  
                - cpu型号
                  
                - 单价
                  
                - 数据盘
                  
                - 可租用至
                  
        - 创建按钮
          
            - 点击后批量创建实例
              
    - 验证
      
        - 系统需要验证在使用期间，是否有足够的资源可以分配
          
- 创建团队实例
  
    - 功能描述：为选定的团队，批量创建实例
      
    - 表单内容
      
        - 选择用途
          
            - AI训练
              
            - 图形处理
              
            - 普通办公
              
        - 选择模板
          
            - 根据用途筛选模板
              
        - 选择团队
          
            - 选择团队/或团队内多个学员
              
        - 选择机房
          
        - 选择配置
          
            - GPU
              
                - 要显示gpu的类型/可用数量
                  
                - 选择GPU数量
                  
            - CPU
              
            - 内存
              
            - 分配约束
              
                - 用GPU：GPU/CPU/内存的比例 1:8:32
                  
                - 只用CPU：cpu和内存可以根据需要自己调配
                  
        - 选择数据盘容量
          
            - 默认50G
              
            - 可以增加，但需要额外收费
              
        - 使用时长
          
            - 按0.5小时单位
              
        - 选择主机
          
            - 根据配置，在主机池中选择可以满足条件的主机。
              
            - 列表显示
              
                - 主机id
                  
                - gpu型号/显存
                  
                - 驱动/cuda
                  
                - cpu型号
                  
                - 数据盘
                  
                - 可租用至
                  
                - 单价
                  
        - 创建按钮
          
            - 点击后批量创建实例
              
- 创建资源申请
  
    - 功能描述：提前锁定主机资源，使用时，可以自动创建实例
      
    - 表单内容
      
        - 选择用途
          
            - AI训练
              
            - 图形处理
              
            - 普通办公
              
        - 选择模板
          
            - 根据用途筛选模板
              
        - 选择团队
          
            - 选择团队/或团队内多个学员
              
        - 选择机房
          
        - 选择配置
          
            - GPU
              
                - 要显示gpu的类型/可用数量
                  
                - 选择GPU数量
                  
            - CPU
              
            - 内存
              
            - 分配约束
              
                - 用GPU：GPU/CPU/内存的比例 1:8:32
                  
                - 只用CPU：cpu和内存可以根据需要自己调配
                  
        - 设置计划开机时间/关机时间
          
        - 提交按钮
          
            - 审批通过后，系统将会确保申请时间段内有足够的资源可以提供
              
