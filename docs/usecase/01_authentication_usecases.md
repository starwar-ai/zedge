# 用户认证与授权用例 (Authentication & Authorization Use Cases)

## 模块概述

用户认证与授权模块负责用户身份验证、会话管理、权限控制和访问令牌管理。

**相关实体**: User, Role, Permission, UserGroup
**主要服务**: AuthService, UserService, PermissionService
**API路由**: `/api/v1/auth`, `/api/v1/users`

---

## 用例列表

### UC-AUTH-001: 用户注册
**参与者**: 新用户、租户管理员、系统管理员
**前置条件**:
- 租户已存在（如果是租户内用户）
- 拥有用户创建权限

**主要流程**:
1. 参与者提交注册信息（用户名、邮箱、密码、租户ID）
2. 系统验证用户名和邮箱唯一性
3. 系统验证租户存在且状态为active
4. 系统使用bcrypt加密密码（salt rounds: 10）
5. 系统创建用户记录，设置默认角色
6. 系统分配默认资源配额
7. 系统返回用户信息（不含密码）

**后置条件**:
- 用户记录已创建
- 用户可以登录系统

**异常流程**:
- E1: 用户名已存在 → 返回409错误
- E2: 邮箱已存在 → 返回409错误
- E3: 租户不存在或已禁用 → 返回400错误
- E4: 密码不符合强度要求 → 返回400错误

**API端点**: `POST /api/v1/auth/register`

**请求示例**:
```json
{
  "username": "john.doe",
  "email": "john@example.com",
  "password": "SecureP@ssw0rd",
  "tenantId": "tenant-uuid",
  "firstName": "John",
  "lastName": "Doe"
}
```

---

### UC-AUTH-002: 用户登录
**参与者**: 注册用户
**前置条件**:
- 用户已注册
- 用户账号未被禁用

**主要流程**:
1. 用户提交登录凭证（用户名/邮箱 + 密码）
2. 系统验证用户存在
3. 系统使用bcrypt比对密码
4. 系统检查用户状态（is_disabled）
5. 系统检查租户状态
6. 系统生成JWT访问令牌（有效期: 15分钟）
7. 系统生成刷新令牌（有效期: 7天）
8. 系统记录登录时间（last_login）
9. 系统返回令牌和用户信息

**后置条件**:
- 用户获得访问令牌
- 用户可以访问受保护资源

**异常流程**:
- E1: 用户不存在 → 返回401错误
- E2: 密码错误 → 返回401错误
- E3: 用户已禁用 → 返回403错误
- E4: 租户已暂停 → 返回403错误

**API端点**: `POST /api/v1/auth/login`

**请求示例**:
```json
{
  "username": "john.doe",
  "password": "SecureP@ssw0rd"
}
```

**响应示例**:
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "refresh-token-string",
  "expiresIn": 900,
  "user": {
    "userId": "user-uuid",
    "username": "john.doe",
    "email": "john@example.com",
    "role": "user",
    "tenantId": "tenant-uuid"
  }
}
```

---

### UC-AUTH-003: 刷新访问令牌
**参与者**: 已登录用户
**前置条件**:
- 用户持有有效的刷新令牌
- 刷新令牌未过期

**主要流程**:
1. 用户提交刷新令牌
2. 系统验证刷新令牌签名和有效期
3. 系统提取用户ID
4. 系统验证用户仍然存在且未禁用
5. 系统生成新的访问令牌
6. 系统可选地生成新的刷新令牌（Token轮换）
7. 系统返回新令牌

**后置条件**:
- 用户获得新的访问令牌
- 可选：旧刷新令牌失效

**异常流程**:
- E1: 刷新令牌无效 → 返回401错误
- E2: 刷新令牌已过期 → 返回401错误
- E3: 用户已禁用 → 返回403错误

**API端点**: `POST /api/v1/auth/refresh`

---

### UC-AUTH-004: 用户登出
**参与者**: 已登录用户
**前置条件**:
- 用户持有有效的访问令牌

**主要流程**:
1. 用户发送登出请求
2. 系统将访问令牌加入黑名单（可选）
3. 系统将刷新令牌加入黑名单（可选）
4. 系统返回成功响应

**后置条件**:
- 用户令牌失效
- 用户需要重新登录

**API端点**: `POST /api/v1/auth/logout`

---

### UC-AUTH-005: 修改密码
**参与者**: 已登录用户
**前置条件**:
- 用户已认证

**主要流程**:
1. 用户提交当前密码和新密码
2. 系统验证当前密码正确性
3. 系统验证新密码强度
4. 系统验证新密码与当前密码不同
5. 系统使用bcrypt加密新密码
6. 系统更新用户密码
7. 系统可选地使所有现有令牌失效（强制重新登录）
8. 系统返回成功响应

**后置条件**:
- 用户密码已更新
- 可选：用户需要重新登录

**异常流程**:
- E1: 当前密码错误 → 返回401错误
- E2: 新密码不符合强度要求 → 返回400错误
- E3: 新密码与当前密码相同 → 返回400错误

**API端点**: `PATCH /api/v1/users/me/password`

---

### UC-AUTH-006: 重置密码（忘记密码）
**参与者**: 用户
**前置条件**:
- 用户邮箱已验证

**主要流程**:
1. 用户请求密码重置（提供邮箱）
2. 系统验证邮箱存在
3. 系统生成密码重置令牌（有效期: 1小时）
4. 系统发送重置链接到用户邮箱
5. 用户点击链接，提供重置令牌和新密码
6. 系统验证重置令牌有效性
7. 系统更新用户密码
8. 系统使重置令牌失效
9. 系统返回成功响应

**后置条件**:
- 用户密码已重置
- 重置令牌已失效

**异常流程**:
- E1: 邮箱不存在 → 返回成功响应（安全考虑，不暴露用户信息）
- E2: 重置令牌无效或过期 → 返回400错误

**API端点**:
- `POST /api/v1/auth/forgot-password` - 请求重置
- `POST /api/v1/auth/reset-password` - 执行重置

---

### UC-AUTH-007: 获取当前用户信息
**参与者**: 已登录用户
**前置条件**:
- 用户持有有效的访问令牌

**主要流程**:
1. 用户发送请求（带访问令牌）
2. 系统验证令牌
3. 系统提取用户ID
4. 系统查询用户完整信息（含角色、权限、配额）
5. 系统返回用户信息（不含密码）

**后置条件**:
- 用户获得个人信息

**API端点**: `GET /api/v1/users/me`

**响应示例**:
```json
{
  "userId": "user-uuid",
  "username": "john.doe",
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "role": "user",
  "tenantId": "tenant-uuid",
  "quota": {
    "maxInstances": 10,
    "maxCpuCores": 32,
    "maxMemoryGb": 64,
    "maxStorageGb": 500,
    "maxPrivateDataDiskGb": 2000
  },
  "isDisabled": false,
  "createdAt": "2025-01-01T00:00:00Z"
}
```

---

### UC-AUTH-008: 更新用户个人资料
**参与者**: 已登录用户
**前置条件**:
- 用户已认证

**主要流程**:
1. 用户提交更新信息（名字、邮箱等）
2. 系统验证字段格式
3. 系统验证邮箱唯一性（如果修改邮箱）
4. 系统更新用户记录
5. 系统返回更新后的用户信息

**后置条件**:
- 用户信息已更新

**异常流程**:
- E1: 邮箱已被使用 → 返回409错误
- E2: 字段格式无效 → 返回400错误

**API端点**: `PATCH /api/v1/users/me`

---

### UC-AUTH-009: 管理员创建用户
**参与者**: 租户管理员、系统管理员
**前置条件**:
- 拥有`users:create`权限

**主要流程**:
1. 管理员提交新用户信息
2. 系统验证管理员权限
3. 系统验证租户权限（租户管理员只能创建本租户用户）
4. 系统验证用户名和邮箱唯一性
5. 系统生成临时密码或发送设置密码邮件
6. 系统创建用户记录
7. 系统分配指定角色和权限
8. 系统返回用户信息

**后置条件**:
- 新用户已创建
- 用户收到激活邮件（可选）

**API端点**: `POST /api/v1/users`

---

### UC-AUTH-010: 管理员禁用/启用用户
**参与者**: 租户管理员、系统管理员
**前置条件**:
- 拥有`users:update`权限

**主要流程**:
1. 管理员选择用户并设置禁用状态
2. 系统验证管理员权限
3. 系统验证租户权限（租户管理员只能管理本租户用户）
4. 系统更新用户的`is_disabled`字段
5. 如果禁用，系统使该用户所有令牌失效
6. 系统返回成功响应

**后置条件**:
- 用户状态已更新
- 如果禁用，用户无法登录

**API端点**: `PATCH /api/v1/users/:userId`

---

### UC-AUTH-011: 查询用户列表
**参与者**: 租户管理员、系统管理员
**前置条件**:
- 拥有`users:read`权限

**主要流程**:
1. 管理员请求用户列表（可带筛选条件）
2. 系统验证管理员权限
3. 系统应用租户过滤（租户管理员只能看本租户用户）
4. 系统应用搜索和筛选条件
5. 系统应用分页参数
6. 系统返回用户列表（不含密码）

**后置条件**:
- 管理员获得用户列表

**API端点**: `GET /api/v1/users`

**查询参数**:
- `tenantId`: 租户ID筛选
- `role`: 角色筛选
- `search`: 搜索用户名/邮箱
- `page`: 页码
- `limit`: 每页数量

---

### UC-AUTH-012: 分配用户角色
**参与者**: 租户管理员、系统管理员
**前置条件**:
- 拥有`users:update`权限

**主要流程**:
1. 管理员为用户分配新角色
2. 系统验证管理员权限
3. 系统验证角色存在且有效
4. 系统验证权限层级（不能分配高于自己的角色）
5. 系统更新用户角色
6. 系统记录角色变更日志
7. 系统返回成功响应

**后置条件**:
- 用户角色已更新
- 用户权限已变更

**API端点**: `PATCH /api/v1/users/:userId/role`

---

### UC-AUTH-013: 检查用户权限
**参与者**: 系统、应用
**前置条件**:
- 用户已认证

**主要流程**:
1. 系统/应用请求检查用户权限
2. 系统加载用户角色
3. 系统加载角色关联的权限
4. 系统检查用户组权限（如果有）
5. 系统合并所有权限
6. 系统检查是否拥有目标权限
7. 系统返回检查结果

**后置条件**:
- 返回权限检查结果

**权限检查逻辑**:
```
用户总权限 = 角色权限 ∪ 用户组权限 ∪ 直接分配的权限
```

**内部使用**: 中间件、装饰器

---

### UC-AUTH-014: 用户加入用户组
**参与者**: 租户管理员
**前置条件**:
- 拥有`userGroups:update`权限
- 用户和用户组属于同一租户

**主要流程**:
1. 管理员将用户添加到用户组
2. 系统验证管理员权限
3. 系统验证用户和用户组存在
4. 系统验证租户一致性
5. 系统创建用户-用户组关联
6. 系统返回成功响应

**后置条件**:
- 用户已加入用户组
- 用户继承用户组权限

**API端点**: `POST /api/v1/user-groups/:groupId/members`

---

### UC-AUTH-015: 用户离开用户组
**参与者**: 租户管理员
**前置条件**:
- 拥有`userGroups:update`权限

**主要流程**:
1. 管理员将用户从用户组移除
2. 系统验证管理员权限
3. 系统验证用户在该用户组中
4. 系统删除用户-用户组关联
5. 系统返回成功响应

**后置条件**:
- 用户已离开用户组
- 用户失去用户组权限

**API端点**: `DELETE /api/v1/user-groups/:groupId/members/:userId`

---

## 权限矩阵

| 用例 | 超级管理员 | 租户管理员 | 普通用户 | 说明 |
|-----|----------|----------|---------|------|
| UC-AUTH-001 注册 | ✓ | ✓ | ✗ | 普通用户通过公开注册接口 |
| UC-AUTH-002 登录 | ✓ | ✓ | ✓ | 所有用户 |
| UC-AUTH-003 刷新令牌 | ✓ | ✓ | ✓ | 所有用户 |
| UC-AUTH-004 登出 | ✓ | ✓ | ✓ | 所有用户 |
| UC-AUTH-005 修改密码 | ✓ | ✓ | ✓ | 仅自己的密码 |
| UC-AUTH-006 重置密码 | ✓ | ✓ | ✓ | 所有用户 |
| UC-AUTH-007 获取信息 | ✓ | ✓ | ✓ | 仅自己的信息 |
| UC-AUTH-008 更新资料 | ✓ | ✓ | ✓ | 仅自己的资料 |
| UC-AUTH-009 创建用户 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |
| UC-AUTH-010 禁用用户 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |
| UC-AUTH-011 查询用户 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |
| UC-AUTH-012 分配角色 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |
| UC-AUTH-013 检查权限 | ✓ | ✓ | ✓ | 系统内部 |
| UC-AUTH-014 加入用户组 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |
| UC-AUTH-015 离开用户组 | ✓ | ✓ (本租户) | ✗ | 管理员权限 |

---

## 安全考虑

### 密码安全
- 使用bcrypt加密（salt rounds: 10）
- 强制密码复杂度要求
- 密码不在API响应中返回
- 密码重置令牌有效期限制

### 令牌安全
- JWT访问令牌短有效期（15分钟）
- 刷新令牌长有效期（7天）
- 支持令牌黑名单
- HTTPS传输

### 访问控制
- 基于角色的访问控制（RBAC）
- 租户隔离
- 资源所有权验证
- 最小权限原则

### 审计日志
- 记录所有认证事件
- 记录权限变更
- 记录失败的登录尝试

---

## 相关文档
- [租户管理用例](02_tenant_usecases.md)
- [用户组管理](../domain_model.md#用户组)
- [权限系统设计](../domain_model.md#权限管理)
